{"version":3,"sources":["../../routers/api.js"],"names":["require","exec","fs","express","request","requestPromise","md5","sillyDateTime","multer","Geetest","salt","crt_token","router","Router","Users","Docs","Articles","Discuss","Tags","Slide","Photos","Collections","emailRegexp","phoneRegexp","uoloader","NowDate","Date","downloadBasecDir","use","req","res","next","output","code","msg","ok","data","get","captcha","geetest_id","geetest_key","register","err","console","error","send","find","isDel","then","docs","json","slides","uid","query","findOne","_id","usersInfo","keyWord","keyword","reg","RegExp","$or","name","$regex","users","cookies","session","offset","parseInt","num","where","skip","limit","token","all","alls","forEach","item","add_date","format","doc_id","articles","id","article","watch","save","cookie","maxAge","expires","article_id","discuss","post","body","password","form","validateCode","remember","user","test","email","phone","passwordConfirm","_scrf","findData","userInfo","t_salt","sex","nick","wechat","qq","avatar","signature","website","introduce","editors","follow","github_id","github","html_url","type","newUsers","inser","photos","describe","clearCookie","destroy","redirect","updateUserBasic","update","multi","log","updateProfile","updateReward","rewardStatus","rewardDesc","contents","markDownText","markdownText","title","article_date","allArticles","dirname","existsSync","mkdirSync","writeFile","encoding","maxBuffer","stdout","stderr","tar_path","insert","doc_name","user_name","author","start","fork","isRelease","article_uid","single","ext","file","mimetype","split","filename","now_timer","buffer","originalname","path","fullpath","size","message","url","success","icon","push","admins","verify","collections","subscribe","include","article_ids","coll","doc","colls","articleArr","length","ids","follow_id","uids","state","getTime","getTokenOptations","uri","qs","client_id","client_secret","redirect_uri","headers","getGithubUsersOptaions","access_token","user_data","avatar_url","add","e","catch","module","exports"],"mappings":"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","file":"api.js","sourcesContent":["const { exec } = require('child_process');\nconst fs = require('fs');\nconst express = require('express');\nconst request = require('request');\nconst requestPromise = require('request-promise');\nconst md5 = require('md5');\nconst sillyDateTime = require('silly-datetime');\nconst multer  = require('multer');\nconst Geetest = require('gt3-sdk');\nconst salt = require('../libs/salt');\nconst crt_token = require('../libs/ctr_token');\nconst router = express.Router();\nconst Users = require('../models/Users_model');\nconst Docs = require('../models/Document_model');\nconst Articles = require('../models/Articles_model');\nconst Discuss = require('../models/Discuss_model');\nconst Tags = require('../models/Tags_model');\nconst Slide = require('../models/Slide_model');\nconst Photos = require('../models/Photos_model');\nconst Collections = require('../models/Collections_model');\nconst emailRegexp = /^[a-z0-9]+([._\\\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/;\nconst phoneRegexp = /^((13[0-9])|(14[5|7])|(15([0-3]|[5-9]))|(18[0,5-9]))\\\\d{8}$/;\nconst uoloader = multer(); //{dest: 'uploads/'}设置dest表示上传文件的目录，如果不设置上传的文件永远在内存之中不会保存到磁盘上。在此处为了在内存中取出文件并重命名所以不设置文件上传路径\nconst NowDate = new Date();\nconst downloadBasecDir = '/Users/bluelife/www/node/blog/download/';\n\nrouter.use(function(req, res, next) {\n    output = {\n        code: 0,\n        msg: '',\n        ok:false,\n        data: null\n    };\n    next();\n});\n\nrouter.get('/gettest',(req,res,next)=>{\n    let captcha = new Geetest({\n        geetest_id: 'e46e906d776dbd41c4e72f72499ca39f',\n        geetest_key: '30b094aad22445378f7fdc01b83215bb'\n    }).register(null,(err,data)=>{\n        if (err) {\n            console.error(err);\n            return;\n        }\n        res.send(data);\n        // console.log(data);\n\n        // if (!data.success) {\n        //     // 进入 fallback，如果一直进入此模式，请检查服务器到极验服务器是否可访问\n        //     // 可以通过修改 hosts 把极验服务器 api.geetest.com 指到不可访问的地址\n        //     // 为以防万一，你可以选择以下两种方式之一：\n        //     // 1. 继续使用极验提供的failback备用方案\n        //     req.session.fallback = true;\n        //     res.send(data);\n        //     // 2. 使用自己提供的备用方案\n        //     // todo\n        // } else {\n        //     // 正常模式\n        //     req.session.fallback = false;\n        //     res.send(data);\n        // }\n    });\n});\n\n/**\n * 获取所有标签\n */\nrouter.get('/docs',(req, res, next)=>{\n    // console.log(Tags);\n    // res.send();\n    Docs.find({isDel:0}).then(docs=>{\n        if(docs){\n            output.code = 1;\n            output.msg = 'success';\n            output.ok = true;\n            output.data = docs;\n            res.json(output);\n            return;\n        }else{\n            output.code = 0;\n            output.msg = 'error';\n            output.ok = false;\n            output.data = {};\n            res.json(output);\n            return;\n        }\n    });\n});\n\n/**\n * 获取幻灯片\n */\nrouter.get('/slides',(req, res, next)=>{\n    Slide.find().then(slides=>{\n        if(slides){\n            output.code = 1;\n            output.msg = 'success';\n            output.ok = true;\n            output.data = slides;\n            res.json(output);\n            return;\n        }else{\n            output.code = 0;\n            output.msg = 'error';\n            output.ok = false;\n            output.data = {};\n            res.json(output);\n            return;\n        }\n    });\n})\n\nrouter.get('/getUsers',(req, res, next)=>{\n    let uid = req.query.uid;\n    Users.findOne({_id:uid, isDel:0}).then(usersInfo=>{\n        if(usersInfo){\n            output.code = 1;\n            output.msg = 'success';\n            output.ok = true;\n            output.data = usersInfo;\n            res.json(output);\n        }else{\n            output.code = 0;\n            output.msg = 'error';\n            output.ok = false;\n            output.data = {};\n            res.json(output);\n        }\n    });\n});\n\nrouter.get('/allUsers',(req,res,next)=>{\n    let keyWord = req.query.keyword;\n    const reg = new RegExp(keyWord, 'si') //不区分大小写\n    Users.find({\n        // name:{$regex : /keyWord/,$options: 'si'}\n        $or : [ //多条件，数组\n            {name : {$regex : reg}}\n        ]\n    }).then(users=>{\n        if(users){\n            output.code = 1;\n            output.msg = 'success';\n            output.ok = true;\n            output.data = users;\n            res.json(output);\n        }else{\n            output.code = 0;\n            output.msg = 'error';\n            output.ok = false;\n            output.data = {};\n            res.json(output);\n        }\n    });\n})\n\nrouter.get('/getDocLists',(req, res, next)=>{\n    let uid = req.query.uid ? req.query.uid :(req.cookies.uid || req.session.uid);\n    let offset = req.query.offset ? parseInt(req.query.offset): 1;\n    let num = req.query.num ? parseInt(req.query.num): 20;\n    let where = uid ? {uid:uid,isDel:0} : {isDel:0};\n    Docs.find(where).skip((offset == 0 ? offset : (offset-1))).limit(num).then(docs=>{\n        if(docs){\n            output.code = 1;\n            output.msg = 'success';\n            output.ok = true;\n            output.data = docs;\n            res.json(output);\n        }else{\n            output.code = 0;\n            output.msg = 'error';\n            output.ok = false;\n            output.data = {};\n            res.json(output);\n        }\n    });\n});\n\nrouter.get('/allArticles',(req, res, next)=>{\n    let uid = req.query.uid ? req.query.uid : (req.cookies.token && req.cookies.uid);\n    let all = false;\n    let offset = req.query.offset ? parseInt(req.query.offset) : 0;\n    let num = req.query.num ? parseInt(req.query.num) : 10;\n    if(!uid){\n        all = true;\n    }\n    let where = all ? {isDel:0}: {uid:uid,isDel:0};\n    Articles.find(where).skip((offset == 0 ? offset : (offset-1))).limit(num).then(alls=>{\n        if(alls){\n            alls.forEach(item=>{\n                item.add_date = sillyDateTime.format(item.add_date,'YYYY-MM-DD HH:mm:ss');\n            });\n            output.code = 1;\n            output.msg = 'success';\n            output.ok = true;\n            output.data = alls;\n            res.json(output);\n        }else{\n            output.code = 0;\n            output.msg = 'error';\n            output.ok = false;\n            output.data = {};\n            res.json(output);\n        }\n    });\n})\n\nrouter.get('/getArticleLists',(req, res, next)=>{\n    let doc_id = req.query.doc_id;\n    Articles.find({\n        doc_id:doc_id,\n        isDel:0\n    }).then(articles=>{\n        // console.log(articles);\n        if(articles){\n            output.code = 1;\n            output.msg = 'success';\n            output.ok = true;\n            output.data = articles;\n            res.json(output);\n        }else{\n            output.code = 0;\n            output.msg = 'error';\n            output.ok = false;\n            output.data = {};\n            res.json(output);\n        }\n    });\n});\n\nrouter.get('/getArticle',(req, res, next)=>{\n    let id = req.query.id;\n    Articles.findOne({_id:id}).then(article=>{\n        if(article){\n            article.add_date = sillyDateTime.format(article.add_date,'YYYY-MM-DD HH:mm:ss');\n            if(!req.cookies.id){\n                //增加阅读数\n                article.watch++;\n                article.save();\n                res.cookie(id,'on',{maxAge:1000*3600*10,expires:1000*3600*10});\n            }\n\n            Discuss.find({article_id:article._id}).then(discuss=>{\n                output.code = 1;\n                output.msg = 'success';\n                output.ok = true;\n                output.data = {\n                    'article' : article,\n                    'discuss' : discuss\n                };\n                res.json(output);\n            });\n\n        }else{\n            output.code = 0;\n            output.msg = 'error';\n            output.ok = false;\n            output.data = {};\n            res.json(output);\n        }\n    });\n})\n\nrouter.post('/signin', (req, res, next) => {\n    // let redirect = req.body.redirect ? req.body.redirect : '';\n    let name = req.body.name;\n    let password = req.body.password;\n    let form = req.body.form;\n    let validateCode = form == 'login' ? req.body.validateCode : '';\n    let remember = req.body.remember;\n    if (name == '') {\n        output.code = 0;\n        output.msg = '用户名不能为空';\n        res.json(output);\n        return;\n    }\n    if (password == '') {\n        output.code = 0;\n        output.msg = \"密码不能为空\";\n        res.json(output);\n        return;\n    }\n    if(form == 'login'){\n        if(validateCode == ''){\n            output.code = 0;\n            output.msg = \"请先通过验证\";\n            res.json(output);\n            return;\n        }\n    }\n    let user = {};\n    if(emailRegexp.test(name)){\n        user.email = name;\n    }else if(phoneRegexp.test(name)){\n        user.phone = name;\n    }else{\n        user.name = name;\n    }\n    Users.findOne(user).then(function(user) {\n        if (user) {\n            if(user.password == md5(password+user.salt)){\n                res.cookie('uid',user._id);\n                req.session.uid = user._id;\n                if(remember){\n                    res.cookie('name',name,{maxAge: 3600000*24*7});\n                    res.cookie('password',password,{maxAge: 3600000*24*7});\n                }\n                output.code = 1;\n                output.msg = \"success\";\n                output.ok = true;\n                output.data = user;\n                res.json(output);\n                return;\n            }else{\n                output.code = 0;\n                output.msg = \"登录失败，密码不正确\";\n                output.ok = false;\n                output.data = null;\n                res.json(output);\n            }\n        } else {\n            output.code = 2;\n            output.msg = \"您还没有帐号，请注册帐号\";\n            output.data = '';\n            res.json(output);\n        }\n    });\n});\n\nrouter.post('/signup',(req, res, next)=>{\n    let name = req.body.name;\n    let phone = req.body.phone;\n    let password = req.body.password;\n    let passwordConfirm = req.body.passwordConfirm;\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    if (name == '') {\n        output.code = 0;\n        output.msg = '用户名不能为空';\n        res.json(output);\n        return;\n    }\n    if (password == '') {\n        output.code = 0;\n        output.msg = \"密码不能为空\";\n        res.json(output);\n        return;\n    }\n\n    if(password != passwordConfirm){\n        output.code = 0;\n        output.msg = \"两次输入密码不同\";\n        res.json(output);\n        return;\n    }\n\n    let findData = {};\n    if(emailRegexp.test(name)){\n        findData.email = name;\n    }else if(phoneRegexp.test(name)){\n        findData.phone = name;\n    }else{\n        findData.name = name;\n    }\n    Users.findOne(findData).then(userInfo=>{\n        if(userInfo){\n            output.code = 0;\n            output.ok = false;\n            output.msg = '帐号已存在，请注册新帐号';\n            output.data = null;\n            res.json(output);\n        }else{\n            let t_salt = salt();\n            let user = {\n                name:'',\n                phone : '',\n                email : '',\n                password:'',\n                salt : '',\n                sex: 3,\n                nick: '',\n                wechat: '',\n                qq: '',\n                avatar: '',\n                signature:'',\n                website: '',\n                introduce : '',\n                editors : 2,\n                follow:0,\n                github_id:'',\n                github:{\n                    html_url:''\n                },\n                add_date : sillyDateTime.format(new Date(),'YYYY-MM-DD HH:mm:ss'),\n                isDel : 0,\n            };\n            if(emailRegexp.test(name)){\n                user.email = name;\n                user.type = 3;\n            }else if(phoneRegexp.test(name)){\n                user.phone = name;\n                user.type = 2;\n            }else{\n                user.name = name;\n                user.type = 1;\n            }\n            user.name = name;\n            user.salt = t_salt;\n            user.password = md5(password+t_salt);\n            let newUsers = new Users(user);\n            return newUsers.save();\n        }\n    }).then(inser => {\n        new Docs({\n            uid: inser._id,\n            name: '随笔',\n            photos: '',\n            describe: '',\n            add_date: sillyDateTime.format(new Date(),'YYYY-MM-DD HH:mm:ss'),\n            isDel: 0,\n        }).save();\n        if(inser){\n            output.code = 1;\n            output.ok = true;\n            output.msg = '注册成功';\n            output.data = {id:inser._id};\n            res.json(output);\n        }else{\n            output.code = 2;\n            output.ok = true;\n            output.msg = '注册失败';\n            output.data = null;\n            res.json(output);\n        }\n    });\n});\n\nrouter.get('/signout',(req,res,next)=>{\n    res.clearCookie('uid');         // 清除cookie中的uid\n    req.session.destroy(()=>{       // 销毁session中的uid\n        res.redirect(302,'/login');\n    });\n    // console.log(store);\n    // req.session.store.clear(()=>{\n    //     res.redirect(302,'/login');\n    // })\n});\n\nrouter.post('/updateUserBasic',(req,res,next)=>{\n    let uid = req.body.uid ? req.body.uid : req.session.uid;\n    let updateUserBasic = {\n        nick: req.body.nick,\n        phone: req.body.phone,\n        email: req.body.email,\n        editors: req.body.editors,\n        avatar: req.body.avatar,\n        qq:req.body.qq,\n        wechat:req.body.wechat,\n        github:req.body.github\n    };\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    if(req.session.uid == ''){\n        output.code = 0;\n        output.msg = '未登陆';\n        res.json(output);\n        return;\n    }\n    Users.update({_id:uid},updateUserBasic,{multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        output.code = 1;\n        output.ok = true;\n        output.msg = '用户基础信息修改成功';\n        output.data = {};\n        res.json(output);\n    });\n});\n\nrouter.post('/changeProfile',(req,res,next)=>{\n    let uid = req.body.uid ? req.body.uid : req.session.uid;\n    let updateProfile = {\n        sex:req.body.sex,\n        introduce:req.body.introduce,\n        website:req.body.website\n    };\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    if(req.session.uid == ''){\n        output.code = 0;\n        output.msg = '未登陆';\n        res.json(output);\n        return;\n    }\n    Users.update({_id:uid},updateProfile,{multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        output.code = 1;\n        output.ok = true;\n        output.msg = '用户个人资料修改成功';\n        output.data = {};\n        res.json(output);\n    });\n});\n\nrouter.post('/changeReward',(req,res,next)=>{\n    let uid = req.body.uid ? req.body.uid : req.session.uid;\n    let updateReward = {\n        rewardStatus:req.body.rewardStatus,\n        rewardDesc:req.body.rewardDesc\n    };\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    if(req.session.uid == ''){\n        output.code = 0;\n        output.msg = '未登陆';\n        res.json(output);\n        return;\n    }\n    Users.update({_id:uid},updateReward,{multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        output.code = 1;\n        output.ok = true;\n        output.msg = '赞赏修改成功';\n        output.data = {};\n        res.json(output);\n    });\n});\n\nrouter.post('/saveArticle',(req,res,next)=>{\n    let id = req.body.id;\n    let contents = req.body.contents;\n    let markDownText = req.body.markdownText ? req.body.markdownText:null;\n    let title = req.body.title;\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    let article_date = {\n        contents:contents,\n        title:title\n    };\n    if(markDownText){\n        article_date.markDownText = markDownText;\n    }\n    Articles.update({_id:id},article_date,{multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        output.code = 1;\n        output.ok = true;\n        output.msg = '文章修改成功';\n        output.data = {};\n        res.json(output);\n    });\n});\n\nrouter.get('/downloadAllArticles',(req,res,next)=>{\n    let uid = req.query.uid ? req.query.uid : req.cookies.uid;\n    if(req.session.uid == ''){\n        output.code = 0;\n        output.ok = false;\n        output.msg = '未登陆';\n        output.data = {};\n        res.json(output);\n        return;\n    }\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    let allArticles = Articles.find({uid:uid}).then(articles=>{\n        return articles;\n    });\n    let dirname = downloadBasecDir+'/'+uid;\n    fs.existsSync(dirname) || fs.mkdirSync(dirname);  // 下载目录不存在创建目录\n    allArticles.then(all=>{\n        all.forEach(article=>{\n            fs.writeFile('/Users/bluelife/www/node/blog/download/'+uid+'/'+article.title+'.md',article.markDownText,'utf8',err=>{\n                if (err) throw err;\n            });\n        });\n        exec('tar -czf '+dirname+'.tar.gz'+' '+dirname,{encoding:'utf8',maxBuffer:parseInt(200*1024)},(error,stdout,stderr)=>{\n            if(error) throw error;\n            output.code = 1;\n            output.ok = true;\n            output.msg = '所有文章打包下载完成';\n            output.data = {tar_path:'http://blog.mcloudhub.com/download/'+uid+'.tar.gz'};\n            res.json(output);\n        });\n    });\n})\n\nrouter.post('/newDocument',(req,res,next)=>{\n    let uid = req.body.uid ? req.body.uid : req.session.uid;\n    let name = req.body.name;\n    let docs = new Docs({\n        uid:uid,\n        name: name,\n        photos: '',\n        describe: '',\n        add_date: sillyDateTime.format(new Date(),'YYYY-MMM-DD HH:mm:ss'),\n        isDel: 0,\n    });\n    docs.save().then(insert=>{\n        output.code = 1;\n        output.ok = true;\n        output.msg = '文集创建成功';\n        output.data = {id:insert._id};\n        res.json(output);\n    });\n});\n\nrouter.post('/updateDocumentName',(req,res,next)=>{\n    let uid = req.body.uid ? req.body.uid : req.session.uid;\n    let id = req.body.id;\n    let name = req.body.name;\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    Docs.update({_id:id,uid:uid},{name:name},{multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        output.code = 1;\n        output.ok = true;\n        output.msg = '文集名称修改成功';\n        output.data = {};\n        res.json(output);\n    })\n})\n\nrouter.post('/newArticle',(req,res,next)=>{\n    let uid = req.body.uid ? req.body.uid : req.session.uid;\n    let doc_id = req.body.doc_id;\n    let doc_name = req.body.doc_name;\n    let user_name = req.body.user_name;\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    let article = new Articles({\n        uid: uid,\n        doc_id:doc_id,  // 文章所属文档id\n        doc_name:doc_name, // 文集名称\n        author: user_name, //文章作者\n        title: sillyDateTime.format(new Date(),'YYYY-MMM-DD'), // 文章标题\n        describe: '', // 文章描述\n        photos: '', // 文章图片\n        contents: '', // 文章内容\n        watch: 0,\n        start: 0,\n        fork: 0,\n        add_date: sillyDateTime.format(new Date(),'YYYY-MM-DD HH:mm:ss'),\n        isRelease: 0,\n        isDel: 0,\n    });\n    article.save().then(insert =>{\n        output.code = 1;\n        output.ok = true;\n        output.msg = '文章创建成功';\n        output.data = {id:insert._id};\n        res.json(output);\n    });\n});\n\nrouter.get('/deleteDoc',(req,res,next)=>{\n    let uid = req.query.uid;\n    let id = req.query.id;\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    Docs.update({_id:id,uid:uid}, {isDel:1}, {multi:false}, (err,docs)=>{\n        if(err) throw console.log(err);\n        output.code = 1;\n        output.ok = true;\n        output.msg = '文集删除成功';\n        output.data = {};\n        res.json(output);\n    })\n});\n\nrouter.get('/releaseArticle',(req,res,next)=> {\n    let uid = req.query.uid;\n    let id = req.query.id;\n    if (req.cookies._scrf == '') {\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    Articles.update({_id: id, uid: uid}, {isRelease: 1}, {multi: false}, (err, docs) => {\n        if (err) throw console.log(err);\n        output.code = 1;\n        output.ok = true;\n        output.msg = '文章已发布';\n        output.data = {};\n        res.json(output);\n    });\n});\n\nrouter.get('/deleteArticle',(req,res,next)=>{\n    let uid = req.query.uid;\n    let id = req.query.id;\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    Articles.update({_id:id,uid:uid}, {isDel:1}, {multi:false}, (err,docs)=>{\n        if(err) throw console.log(err);\n        output.code = 1;\n        output.ok = true;\n        output.msg = '文章删除成功';\n        output.data = {};\n        res.json(output);\n    });\n});\n\nrouter.post('/changeAticleTitle',(req,res,next)=>{\n    let uid = req.body.uid ? req.body.uid : req.session.uid;\n    let id = req.body.id;\n    let title = req.body.title;\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    Articles.update({_id:id,uid:uid}, {title:title}, {multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        output.code = 1;\n        output.ok = true;\n        output.msg = '文章删除成功';\n        output.data = {};\n        res.json(output);\n    });\n});\n\nrouter.post('/postDiscuss',(req,res,next)=>{\n    let id = req.body.id;\n    let contents = req.body.contents;\n    let uid = req.body.uid ? req.body.uid : req.session.uid;\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    if(req.session.uid == ''){\n        output.code = 0;\n        output.msg = '您尚未登录';\n        res.json(output);\n        return;\n    }\n    Articles.findOne({_id:id}).then(article=>{\n        let data = {\n            uid: uid,    //评论的用户id\n            article_id: article._id, //评论的文章id\n            article_uid: article.uid, //评论的文章的用户id\n            contents: contents,   //评论的内容\n            add_date: sillyDateTime.format(new Date(),'YYYY-MM-DD HH:mm:ss'),     //评论时间\n            isDel: 0,\n        };\n        new Discuss(data).save();\n        output.code = 1;\n        output.ok = true;\n        output.msg = '评论成功';\n        output.data = {};\n        res.json(output);\n    });\n});\n\nrouter.get('/getDiscuss',(req,res,next)=>{\n    let id=req.query.id;\n    Discuss.find({article_id:id}).then(discuss=>{\n        if(!discuss) throw console.log(discuss);\n        output.code = 1;\n        output.ok = true;\n        output.msg = 'SUCCESS';\n        output.data = discuss;\n        res.json(output);\n    });\n})\n\nrouter.post('/uploader',uoloader.single('editormd-image-file'),(req,res,next)=>{\n    // console.log(req.file);\n    let ext = req.file.mimetype.split('/')[1];\n    let filename = sillyDateTime.format(new Date(),'YYYYMMMDDHHmmss')+'_'+crt_token()+'.'+ext;\n    let now_timer = sillyDateTime.format(new Date(),'YYYYMMMDD');\n    let dirname = '/Users/bluelife/www/node/blog/public/images/uploads/'+now_timer+'/';\n    fs.existsSync(dirname) || fs.mkdirSync(dirname);  // 目录不存在创建目录\n    fs.writeFile(dirname+filename,req.file.buffer,err=>{\n        if(!err){\n            new Photos({\n                originalname:req.file.originalname,\n                filename: filename,\n                path: dirname,\n                fullpath: dirname+filename,\n                encoding: req.file.encoding,\n                mimetype: req.file.mimetype,\n                size: req.file.size,\n                add_date: sillyDateTime.format(new Date(),'YYYY-MM-DD HH:mm:ss'),\n                isDel: 0\n            }).save().then(insert=>{\n                if(!insert) throw console.log(insert);\n                res.json({\n                    message:'图片上传成功',\n                    url:'https://blog.mcloudhub.com/public/images/uploads/'+now_timer+'/'+filename,\n                    success:1\n                });\n            });\n        }\n    });\n});\n\nrouter.post('/collection/new',(req,res,next)=>{\n    let uid = req.body.uid ? req.body.uid : req.session.uid;\n    let icon = req.body.icon;\n    let name = req.body.name;\n    let describe = req.body.describe;\n    let push = req.body.push;\n    let admins = req.body.admins;\n    let verify = req.body.verify;\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    if(req.session.uid == ''){\n        output.code = 0;\n        output.msg = '您尚未登录';\n        res.json(output);\n        return;\n    }\n    let collections = new Collections({\n        uid: uid,\n        name: name,           // 集合名称\n        type: 1,           // 集合类型\n        icon: icon,           // 集合图标\n        describe: describe,       // 集合描述\n        add_date : sillyDateTime.format(new Date(),'YYYY-MM-DD HH:mm:ss'),        // 集合添加时间,\n        admins: admins,         // 其他管理员\n        push: push,           // 是否允许投稿\n        follow:0,               //关注数\n        subscribe:[],\n        include:0,              //收录文章数\n        article_ids:[],\n        verify: verify,          // 是否需要审核\n        isDel : 0\n    });\n    collections.save().then(coll=>{\n        if(!coll) {\n            output.code = 0;\n            output.ok = false;\n            output.msg = '文集添加失败';\n            output.data = {};\n            res.json(output);\n        }else{\n            output.code = 1;\n            output.ok = true;\n            output.msg = '文集添加成功';\n            output.data = coll;\n            res.json(output);\n        }\n\n    });\n});\n\nrouter.post('/collection/update',(req,res,next)=>{\n    let id = req.body.id;\n    let uid = req.body.uid ? req.body.uid : req.session.uid;\n    let icon = req.body.icon;\n    let name = req.body.name;\n    let describe = req.body.describe;\n    let push = req.body.push;\n    let admins = req.body.admins;\n    let verify = req.body.verify;\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    if(req.session.uid == ''){\n        output.code = 0;\n        output.msg = '您尚未登录';\n        res.json(output);\n        return;\n    }\n    Collections.update({_id:id,uid:uid},{\n        icon:icon,\n        name:name,\n        describe:describe,\n        push:push,\n        verify:verify,\n        admins:admins\n    },{multi:false},(err,doc)=>{\n        if(err) throw console.log(err);\n        output.code = 1;\n        output.ok = true;\n        output.msg = '专题已修改';\n        output.data = {};\n        res.json(output);\n    });\n});\n\nrouter.get('/get_collections',(req,res,next)=>{\n    let offset = req.query.offset ? parseInt(req.query.offset) : 0;\n    let num = req.query.num ? parseInt(req.query.num) : 10;\n    let where = {isDel:0};\n    Collections.find(where).skip((offset == 0 ? offset :(offset-1))*num).limit(num).then(colls=>{\n        if(!colls) throw console.log(colls);\n        output.code = 1;\n        output.ok = true;\n        output.msg = 'SUCCESS';\n        output.data = colls;\n        res.json(output);\n    });\n});\n\nrouter.get('/getCollectionById',(req,res,next)=>{\n    let id = req.query.id;\n    let articleArr = [];\n    Collections.findOne({_id:id}).then(coll=>{\n        if(!coll) throw console.log(coll);\n        output.code = 1;\n        output.ok = true;\n        output.msg = 'SUCCESS';\n        output.data = coll;\n        res.json(output);\n    });\n});\n\nrouter.get('/collectionFollow',(req,res,next)=>{\n    let uid = req.query.uid;\n    let id = req.query.id;\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    Collections.findOne({_id:id}).then(coll=>{\n        coll.follow++;\n        coll.subscribe.push({uid:uid});\n        coll.save();\n        output.code = 1;\n        output.ok = true;\n        output.msg = '关注成功';\n        res.json(output);\n    });\n});\n\nrouter.get('/articlePush',(req,res,next)=>{\n    let uid = req.query.uid;\n    let id = req.query.id;\n    let article_id = req.query.article_id;\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    Collections.findOne({_id:id}).then(coll=>{\n        coll.include++;\n        if(coll.article_ids.length > 0){\n            coll.article_ids.forEach(ids=>{\n                if(ids.id == article_id){\n                    output.code = 0;\n                    output.ok = false;\n                    output.msg = '此文章已投稿，请另选一篇文章再投。';\n                    res.json(output);\n                }else{\n                    coll.article_ids.push({id:article_id});\n                    coll.save();\n                    output.code = 1;\n                    output.ok = true;\n                    output.msg = '投稿成功';\n                    res.json(output);\n                }\n                return;\n            })\n        }else{\n            coll.article_ids.push({id:article_id});\n            coll.save();\n            output.code = 1;\n            output.ok = true;\n            output.msg = '投稿成功';\n            res.json(output);\n            return;\n        }\n    });\n});\n\nrouter.post('/updateIntroduce',(req,res,next)=>{\n    let uid = req.body.uid ? req.body.uid : req.session.uid;\n    let introduce = req.body.introduce;\n    if(req.session.uid == ''){\n        output.code = 0;\n        output.msg = '未登陆';\n        res.json(output);\n        return;\n    }\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    Users.update({_id:uid},{introduce:introduce},{multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        output.code = 1;\n        output.ok = true;\n        output.msg = '用户个人介绍修改成功';\n        output.data = {};\n        res.json(output);\n    });\n});\n\nrouter.get('/documents/get',(req,res,next)=>{\n    let uid = req.query.uid ? req.query.uid:'';\n    let id = req.query.id?req.query.id:'';\n    let where = uid ? {_id:id,uid:uid,isDel:0}: {_id:id,isDel:0};\n    Docs.findOne(where).then(doc=>{\n        if(!doc) throw console.log(doc);\n        output.code = 1;\n        output.ok = true;\n        output.msg = 'SUCCESS';\n        output.data = doc;\n        res.json(output);\n    });\n})\n\nrouter.get('/collections/delete',(req,res,next)=>{\n    let uid = req.query.uid ? req.query.uid:'';\n    let id = req.query.id?req.query.id:'';\n    if(req.session.uid == ''){\n        output.code = 0;\n        output.msg = '未登陆';\n        res.json(output);\n        return;\n    }\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    Collections.update({_id:uid,uid:uid},{isDel:1},{multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        output.code = 1;\n        output.ok = true;\n        output.msg = '专题已删除';\n        output.data = {};\n        res.json(output);\n    });\n})\n\nrouter.get('/users/follow',(req,res,next)=>{\n    let uid = req.query.uid ? req.query.uid:'';\n    let follow_id = req.query.follow_id ? req.query.follow_id : '';\n    if(req.session.uid == ''){\n        output.code = 0;\n        output.msg = '未登陆';\n        res.json(output);\n        return;\n    }\n    if(req.cookies._scrf == ''){\n        output.code = 0;\n        output.msg = '非法请求';\n        res.json(output);\n        return;\n    }\n    if(follow_id){\n        Users.findOne({_id:follow_id}).then(user=>{\n            user.follow++;\n            user.uids.push({id:uid});\n            user.save();\n            output.code = 1;\n            output.ok = true;\n            output.msg = '关注成功';\n            res.json(output);\n            return;\n        });\n    }else{\n        output.code = 0;\n        output.ok = false;\n        output.msg = '关注失败';\n        res.json(output);\n        return;\n    }\n    \n});\n\nrouter.get('/github',(req, res, next)=>{\n    let code = req.query.code;\n    let state = NowDate.getTime();\n    let getTokenOptations = {\n        uri:'https://github.com/login/oauth/access_token',\n        qs: {\n            client_id: '5fe59ee126edbea8f3df',\n            client_secret: 'eaf2f8a2d1b0e21ebdf4ca75628a1dd6c9fdbeff',\n            code: code,\n            redirect_uri: 'https://blog.mcloudhub.com/api/github',\n            state: state,\n        },\n        headers: {\n            'User-Agent': 'Request-Promise'\n        },\n        json: true // Automatically parses the JSON string in the response\n    }\n\n    requestPromise(getTokenOptations).then(token=>{\n        let getGithubUsersOptaions = {\n            uri: 'https://api.github.com/user',\n            headers: {\n                'User-Agent': 'Request-Promise',\n                'Authorization': 'token '+token.access_token,\n            },\n            json: true\n        }\n        requestPromise(getGithubUsersOptaions).then(github=>{\n            console.log(github);\n            if(github){\n                Users.findOne({github_id:github.id}).then(user=>{\n                    if(!user){\n                        let user_data = {\n                            name:github.name,\n                            phone : '',\n                            email : github.email,\n                            password:'',\n                            salt : '',\n                            sex: 3,\n                            nick: github.name,\n                            wechat: '',\n                            qq: '',\n                            avatar: github.avatar_url,\n                            signature:'',\n                            website: '',\n                            introduce : '',\n                            editors : 2,\n                            follow:0,\n                            github_id:github.id,\n                            github:github,\n                            add_date : sillyDateTime.format(new Date(),'YYYY-MM-DD HH:mm:ss'),\n                            isDel : 0,\n                        };\n                        new Users(user_data).save().then(add=>{\n                            try{\n                                res.cookie('uid',add._id);\n                                req.session.uid = add._id;\n                                res.redirect(302,'/');\n                            }catch(e){\n                                console.log(e);\n                                res.redirect(302,'/');\n                            }\n                        });\n                    }else{\n                        res.cookie('uid',user._id);\n                        req.session.uid = user._id;\n                        res.redirect(302,'/');\n                    }\n                });\n            }\n        }).catch(err=>{\n            console.log(err);\n            res.redirect(302,'/');\n        });\n        // https://api.github.com/user?access_token=...\n        // Authorization: token OAUTH-TOKEN\n    }).catch(err=>{\n        console.log(err);\n        res.redirect(302,'/');\n    });\n    // console.log(code);\n    // res.json({code:code});\n});\n\nmodule.exports = router;"]}