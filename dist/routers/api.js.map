{"version":3,"sources":["../../routers/api.js"],"names":["require","exec","fs","express","md5","sillyDateTime","multer","Geetest","salt","crt_token","router","Router","Users","Docs","Articles","Discuss","Tags","Slide","Photos","Collections","emailRegexp","phoneRegexp","uoloader","NowDate","Date","downloadBasecDir","responseData","use","req","res","next","code","msg","ok","data","get","captcha","geetest_id","geetest_key","register","err","console","error","send","cookies","token","json","find","then","tags","slides","uid","query","findOne","_id","isDel","usersInfo","keyWord","keyword","reg","RegExp","$or","name","$regex","users","where","docs","all","offset","parseInt","num","skip","limit","alls","doc_id","articles","id","article","watch","save","set","maxAge","expires","article_id","discuss","post","body","password","form","validateCode","remember","user","test","email","phone","userInfo","passwordConfirm","findData","t_salt","sex","nick","wechat","qq","avatar","signature","website","introduce","editors","add_date","format","type","newUsers","inser","photos","describe","redirect","updateUserBasic","update","multi","log","updateProfile","updateReward","rewardStatus","rewardDesc","contents","markDownText","markdownText","title","article_date","allArticles","dirname","exists","mkdir","forEach","writeFile","encoding","maxBuffer","stdout","stderr","tar_path","insert","doc_name","user_name","author","start","fork","isRelease","article_uid","single","ext","file","mimetype","split","filename","now_timer","buffer","originalname","path","fullpath","size","message","url","success","icon","push","admins","verify","collections","follow","subscribe","include","article_ids","coll","colls","articleArr","length","ids","module","exports"],"mappings":";;eAAiBA,QAAQ,eAAR,C;IAATC,I,YAAAA,I;;AACR,IAAMC,KAAKF,QAAQ,IAAR,CAAX;AACA,IAAMG,UAAUH,QAAQ,SAAR,CAAhB;AACA,IAAMI,MAAMJ,QAAQ,KAAR,CAAZ;AACA,IAAMK,gBAAgBL,QAAQ,gBAAR,CAAtB;AACA,IAAMM,SAAUN,QAAQ,QAAR,CAAhB;AACA,IAAMO,UAAUP,QAAQ,SAAR,CAAhB;AACA,IAAMQ,OAAOR,QAAQ,cAAR,CAAb;AACA,IAAMS,YAAYT,QAAQ,mBAAR,CAAlB;AACA,IAAMU,SAASP,QAAQQ,MAAR,EAAf;AACA,IAAMC,QAAQZ,QAAQ,uBAAR,CAAd;AACA,IAAMa,OAAOb,QAAQ,0BAAR,CAAb;AACA,IAAMc,WAAWd,QAAQ,0BAAR,CAAjB;AACA,IAAMe,UAAUf,QAAQ,yBAAR,CAAhB;AACA,IAAMgB,OAAOhB,QAAQ,sBAAR,CAAb;AACA,IAAMiB,QAAQjB,QAAQ,uBAAR,CAAd;AACA,IAAMkB,SAASlB,QAAQ,wBAAR,CAAf;AACA,IAAMmB,cAAcnB,QAAQ,6BAAR,CAApB;AACA,IAAMoB,cAAc,+EAApB;AACA,IAAMC,cAAc,6DAApB;AACA,IAAMC,WAAWhB,QAAjB,C,CAA2B;AAC3B,IAAMiB,UAAU,IAAIC,IAAJ,EAAhB;AACA,IAAMC,mBAAmB,yCAAzB;AACA,IAAIC,eAAe,EAAnB;;AAEAhB,OAAOiB,GAAP,CAAW,UAASC,GAAT,EAAcC,GAAd,EAAmBC,IAAnB,EAAyB;AAChCJ,mBAAe;AACXK,cAAM,CADK;AAEXC,aAAK,EAFM;AAGXC,YAAG,KAHQ;AAIXC,cAAM;AAJK,KAAf;AAMAJ;AACH,CARD;;AAUApB,OAAOyB,GAAP,CAAW,UAAX,EAAsB,UAACP,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AAClC,QAAIM,UAAU,IAAI7B,OAAJ,CAAY;AACtB8B,oBAAY,kCADU;AAEtBC,qBAAa;AAFS,KAAZ,EAGXC,QAHW,CAGF,IAHE,EAGG,UAACC,GAAD,EAAKN,IAAL,EAAY;AACzB,YAAIM,GAAJ,EAAS;AACLC,oBAAQC,KAAR,CAAcF,GAAd;AACA;AACH;AACDX,YAAIc,IAAJ,CAAST,IAAT;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACH,KAzBa,CAAd;AA0BH,CA3BD;;AA6BA;;;AAGAxB,OAAOyB,GAAP,CAAW,WAAX,EAAuB,UAACP,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAkB;AACrCJ,iBAAaK,IAAb,GAAoB,CAApB;AACAL,iBAAaM,GAAb,GAAmB,SAAnB;AACAN,iBAAaO,EAAb,GAAkB,IAAlB;AACA,QAAGL,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,OAAhB,KAA4BP,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,OAAhB,KAA4B,EAA3D,EAA8D;AAC1DT,qBAAaQ,IAAb,GAAoB;AAChBW,mBAAMjB,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,OAAhB;AADU,SAApB;AAGH,KAJD,MAIK;AACD,YAAIU,QAAQpC,WAAZ;AACAiB,qBAAaQ,IAAb,GAAoB;AAChBW,mBAAMpC;AADU,SAApB;AAGH;AACDoB,QAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH,CAhBD;;AAkBA;;;AAGAhB,OAAOyB,GAAP,CAAW,OAAX,EAAmB,UAACP,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAkB;AACjC;AACA;AACAd,SAAK+B,IAAL,GAAYC,IAAZ,CAAiB,gBAAM;AACnB,YAAGC,IAAH,EAAQ;AACJvB,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,SAAnB;AACAN,yBAAaO,EAAb,GAAkB,IAAlB;AACAP,yBAAaQ,IAAb,GAAoBe,IAApB;AACApB,gBAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH,SAPD,MAOK;AACDA,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,OAAnB;AACAN,yBAAaO,EAAb,GAAkB,KAAlB;AACAP,yBAAaQ,IAAb,GAAoB,EAApB;AACAL,gBAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACJ,KAhBD;AAiBH,CApBD;;AAsBA;;;AAGAhB,OAAOyB,GAAP,CAAW,SAAX,EAAqB,UAACP,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAkB;AACnCb,UAAM8B,IAAN,GAAaC,IAAb,CAAkB,kBAAQ;AACtB,YAAGE,MAAH,EAAU;AACNxB,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,SAAnB;AACAN,yBAAaO,EAAb,GAAkB,IAAlB;AACAP,yBAAaQ,IAAb,GAAoBgB,MAApB;AACArB,gBAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH,SAPD,MAOK;AACDA,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,OAAnB;AACAN,yBAAaO,EAAb,GAAkB,KAAlB;AACAP,yBAAaQ,IAAb,GAAoB,EAApB;AACAL,gBAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACJ,KAhBD;AAiBH,CAlBD;;AAoBAhB,OAAOyB,GAAP,CAAW,WAAX,EAAuB,UAACP,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAkB;AACrC,QAAIqB,MAAMvB,IAAIwB,KAAJ,CAAUD,GAApB;AACAvC,UAAMyC,OAAN,CAAc,EAACC,KAAIH,GAAL,EAAUI,OAAM,CAAhB,EAAd,EAAkCP,IAAlC,CAAuC,qBAAW;AAC9C,YAAGQ,SAAH,EAAa;AACT9B,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,SAAnB;AACAN,yBAAaO,EAAb,GAAkB,IAAlB;AACAP,yBAAaQ,IAAb,GAAoBsB,SAApB;AACA3B,gBAAIiB,IAAJ,CAASpB,YAAT;AACH,SAND,MAMK;AACDA,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,OAAnB;AACAN,yBAAaO,EAAb,GAAkB,KAAlB;AACAP,yBAAaQ,IAAb,GAAoB,EAApB;AACAL,gBAAIiB,IAAJ,CAASpB,YAAT;AACH;AACJ,KAdD;AAeH,CAjBD;;AAmBAhB,OAAOyB,GAAP,CAAW,WAAX,EAAuB,UAACP,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AACnC,QAAI2B,UAAU7B,IAAIwB,KAAJ,CAAUM,OAAxB;AACA,QAAMC,MAAM,IAAIC,MAAJ,CAAWH,OAAX,EAAoB,IAApB,CAAZ,CAFmC,CAEG;AACtC7C,UAAMmC,IAAN,CAAW;AACP;AACAc,aAAM,CAAE;AACJ,UAACC,MAAO,EAACC,QAASJ,GAAV,EAAR,EADE;AAFC,KAAX,EAKGX,IALH,CAKQ,iBAAO;AACX,YAAGgB,KAAH,EAAS;AACLtC,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,SAAnB;AACAN,yBAAaO,EAAb,GAAkB,IAAlB;AACAP,yBAAaQ,IAAb,GAAoB8B,KAApB;AACAnC,gBAAIiB,IAAJ,CAASpB,YAAT;AACH,SAND,MAMK;AACDA,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,OAAnB;AACAN,yBAAaO,EAAb,GAAkB,KAAlB;AACAP,yBAAaQ,IAAb,GAAoB,EAApB;AACAL,gBAAIiB,IAAJ,CAASpB,YAAT;AACH;AACJ,KAnBD;AAoBH,CAvBD;;AAyBAhB,OAAOyB,GAAP,CAAW,cAAX,EAA0B,UAACP,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAkB;AACxC,QAAIqB,MAAMvB,IAAIwB,KAAJ,CAAUD,GAAV,GAAgBvB,IAAIwB,KAAJ,CAAUD,GAA1B,GAAgCvB,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,KAAhB,IAAyBP,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,KAAhB,CAAzB,GAAiD,EAA3F;AACA,QAAI8B,QAAQd,MAAM,EAACA,KAAIA,GAAL,EAASI,OAAM,CAAf,EAAN,GAA0B,EAACA,OAAM,CAAP,EAAtC;AACA1C,SAAKkC,IAAL,CAAUkB,KAAV,EAAiBjB,IAAjB,CAAsB,gBAAM;AACxB,YAAGkB,IAAH,EAAQ;AACJxC,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,SAAnB;AACAN,yBAAaO,EAAb,GAAkB,IAAlB;AACAP,yBAAaQ,IAAb,GAAoBgC,IAApB;AACArC,gBAAIiB,IAAJ,CAASpB,YAAT;AACH,SAND,MAMK;AACDA,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,OAAnB;AACAN,yBAAaO,EAAb,GAAkB,KAAlB;AACAP,yBAAaQ,IAAb,GAAoB,EAApB;AACAL,gBAAIiB,IAAJ,CAASpB,YAAT;AACH;AACJ,KAdD;AAeH,CAlBD;;AAoBAhB,OAAOyB,GAAP,CAAW,cAAX,EAA0B,UAACP,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAkB;AACxC,QAAIqB,MAAM,EAAV;AACA,QAAIgB,MAAM,KAAV;AACA,QAAIC,SAASxC,IAAIwB,KAAJ,CAAUgB,MAAV,GAAmBC,SAASzC,IAAIwB,KAAJ,CAAUgB,MAAnB,CAAnB,GAAgD,CAA7D;AACA,QAAIE,MAAM1C,IAAIwB,KAAJ,CAAUkB,GAAV,GAAgBD,SAASzC,IAAIwB,KAAJ,CAAUkB,GAAnB,CAAhB,GAA0C,EAApD;AACA,QAAG1C,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,OAAhB,KAA4BP,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,KAAhB,CAA/B,EAAsD;AAClDgB,cAAMvB,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,KAAhB,CAAN;AACH,KAFD,MAEK;AACDgC,cAAM,IAAN;AACH;AACD,QAAIF,QAAQE,MAAM,EAACZ,OAAM,CAAP,EAAN,GAAiB,EAACJ,KAAIA,GAAL,EAASI,OAAM,CAAf,EAA7B;AACAzC,aAASiC,IAAT,CAAckB,KAAd,EAAqBM,IAArB,CAA2BH,UAAU,CAAV,GAAcA,MAAd,GAAwBA,SAAO,CAA1D,EAA+DI,KAA/D,CAAqEF,GAArE,EAA0EtB,IAA1E,CAA+E,gBAAM;AACjF,YAAGyB,IAAH,EAAQ;AACJ/C,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,SAAnB;AACAN,yBAAaO,EAAb,GAAkB,IAAlB;AACAP,yBAAaQ,IAAb,GAAoBuC,IAApB;AACA5C,gBAAIiB,IAAJ,CAASpB,YAAT;AACH,SAND,MAMK;AACDA,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,OAAnB;AACAN,yBAAaO,EAAb,GAAkB,KAAlB;AACAP,yBAAaQ,IAAb,GAAoB,EAApB;AACAL,gBAAIiB,IAAJ,CAASpB,YAAT;AACH;AACJ,KAdD;AAeH,CA1BD;;AA4BAhB,OAAOyB,GAAP,CAAW,kBAAX,EAA8B,UAACP,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAkB;AAC5C,QAAI4C,SAAS9C,IAAIwB,KAAJ,CAAUsB,MAAvB;AACA5D,aAASiC,IAAT,CAAc;AACV2B,gBAAOA,MADG;AAEVnB,eAAM;AAFI,KAAd,EAGGP,IAHH,CAGQ,oBAAU;AACd;AACA,YAAG2B,QAAH,EAAY;AACRjD,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,SAAnB;AACAN,yBAAaO,EAAb,GAAkB,IAAlB;AACAP,yBAAaQ,IAAb,GAAoByC,QAApB;AACA9C,gBAAIiB,IAAJ,CAASpB,YAAT;AACH,SAND,MAMK;AACDA,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,OAAnB;AACAN,yBAAaO,EAAb,GAAkB,KAAlB;AACAP,yBAAaQ,IAAb,GAAoB,EAApB;AACAL,gBAAIiB,IAAJ,CAASpB,YAAT;AACH;AACJ,KAlBD;AAmBH,CArBD;;AAuBAhB,OAAOyB,GAAP,CAAW,aAAX,EAAyB,UAACP,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAkB;AACvC,QAAI8C,KAAKhD,IAAIwB,KAAJ,CAAUwB,EAAnB;AACA9D,aAASuC,OAAT,CAAiB,EAACC,KAAIsB,EAAL,EAAjB,EAA2B5B,IAA3B,CAAgC,mBAAS;AACrC,YAAG6B,OAAH,EAAW;AACP,gBAAG,CAACjD,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgByC,EAAhB,CAAJ,EAAwB;AACpB;AACAC,wBAAQC,KAAR;AACAD,wBAAQE,IAAR;AACAnD,oBAAIgB,OAAJ,CAAYoC,GAAZ,CAAgBJ,EAAhB,EAAmB,IAAnB,EAAwB,EAACK,QAAO,OAAK,IAAL,GAAU,EAAlB,EAAqBC,SAAQ,OAAK,IAAL,GAAU,EAAvC,EAAxB;AACH;;AAEDnE,oBAAQgC,IAAR,CAAa,EAACoC,YAAWN,QAAQvB,GAApB,EAAb,EAAuCN,IAAvC,CAA4C,mBAAS;AACjDtB,6BAAaK,IAAb,GAAoB,CAApB;AACAL,6BAAaM,GAAb,GAAmB,SAAnB;AACAN,6BAAaO,EAAb,GAAkB,IAAlB;AACAP,6BAAaQ,IAAb,GAAoB;AAChB,+BAAY2C,OADI;AAEhB,+BAAYO;AAFI,iBAApB;AAIAvD,oBAAIiB,IAAJ,CAASpB,YAAT;AACH,aATD;AAWH,SAnBD,MAmBK;AACDA,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,OAAnB;AACAN,yBAAaO,EAAb,GAAkB,KAAlB;AACAP,yBAAaQ,IAAb,GAAoB,EAApB;AACAL,gBAAIiB,IAAJ,CAASpB,YAAT;AACH;AACJ,KA3BD;AA4BH,CA9BD;;AAgCAhB,OAAO2E,IAAP,CAAY,SAAZ,EAAuB,UAACzD,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AACvC,QAAIgC,OAAOlC,IAAI0D,IAAJ,CAASxB,IAApB;AACA,QAAIyB,WAAW3D,IAAI0D,IAAJ,CAASC,QAAxB;AACA,QAAIC,OAAO5D,IAAI0D,IAAJ,CAASE,IAApB;AACA,QAAIC,eAAeD,QAAQ,OAAR,GAAkB5D,IAAI0D,IAAJ,CAASG,YAA3B,GAA0C,EAA7D;AACA,QAAIC,WAAW9D,IAAI0D,IAAJ,CAASI,QAAxB;AACA,QAAI5B,QAAQ,EAAZ,EAAgB;AACZpC,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,SAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACD,QAAI6D,YAAY,EAAhB,EAAoB;AAChB7D,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,QAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACD,QAAG8D,QAAQ,OAAX,EAAmB;AACf,YAAGC,gBAAgB,EAAnB,EAAsB;AAClB/D,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,QAAnB;AACAH,gBAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACJ;AACD,QAAIiE,OAAO,EAAX;AACA,QAAGvE,YAAYwE,IAAZ,CAAiB9B,IAAjB,CAAH,EAA0B;AACtB6B,aAAKE,KAAL,GAAa/B,IAAb;AACH,KAFD,MAEM,IAAGzC,YAAYuE,IAAZ,CAAiB9B,IAAjB,CAAH,EAA0B;AAC5B6B,aAAKG,KAAL,GAAahC,IAAb;AACH,KAFK,MAED;AACD6B,aAAK7B,IAAL,GAAYA,IAAZ;AACH;AACDlD,UAAMyC,OAAN,CAAcsC,IAAd,EAAoB3C,IAApB,CAAyB,UAAS+C,QAAT,EAAmB;AACxC,YAAIA,QAAJ,EAAc;AACV,gBAAGA,SAASR,QAAT,IAAqBnF,IAAImF,WAASQ,SAASvF,IAAtB,CAAxB,EAAoD;AAChDkB,6BAAaK,IAAb,GAAoB,CAApB;AACAL,6BAAaM,GAAb,GAAmB,SAAnB;AACAN,6BAAaO,EAAb,GAAkB,IAAlB;AACAP,6BAAaQ,IAAb,GAAoB6D,QAApB;AACAnE,oBAAIgB,OAAJ,CAAYoC,GAAZ,CAAgB,KAAhB,EAAsBe,SAASzC,GAA/B,EAAmC,EAAC2B,QAAO,OAAK,IAAL,GAAU,EAAlB,EAAqBC,SAAQ,OAAK,IAAL,GAAU,EAAvC,EAAnC;AACAtD,oBAAIgB,OAAJ,CAAYoC,GAAZ,CAAgB,OAAhB,EAAwBvE,WAAxB,EAAoC,EAACwE,QAAO,OAAK,IAAL,GAAU,EAAlB,EAAqBC,SAAQ,OAAK,IAAL,GAAU,EAAvC,EAApC;AACArD,oBAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH,aATD,MASK;AACDA,6BAAaK,IAAb,GAAoB,CAApB;AACAL,6BAAaM,GAAb,GAAmB,YAAnB;AACAN,6BAAaO,EAAb,GAAkB,KAAlB;AACAP,6BAAaQ,IAAb,GAAoB,IAApB;AACAL,oBAAIiB,IAAJ,CAASpB,YAAT;AACH;AACJ,SAjBD,MAiBO;AACHA,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaM,GAAb,GAAmB,cAAnB;AACAN,yBAAaQ,IAAb,GAAoB,EAApB;AACAL,gBAAIiB,IAAJ,CAASpB,YAAT;AACH;AACJ,KAxBD;AAyBH,CA3DD;;AA6DAhB,OAAO2E,IAAP,CAAY,SAAZ,EAAsB,UAACzD,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAkB;AACpC,QAAIgC,OAAOlC,IAAI0D,IAAJ,CAASxB,IAApB;AACA,QAAIgC,QAAQlE,IAAI0D,IAAJ,CAASQ,KAArB;AACA,QAAIP,WAAW3D,IAAI0D,IAAJ,CAASC,QAAxB;AACA,QAAIS,kBAAkBpE,IAAI0D,IAAJ,CAASU,eAA/B;AACA,QAAInD,QAAQjB,IAAI0D,IAAJ,CAASzC,KAArB;AACA,QAAGA,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACD,QAAIoC,QAAQ,EAAZ,EAAgB;AACZpC,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,SAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACD,QAAI6D,YAAY,EAAhB,EAAoB;AAChB7D,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,QAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;;AAED,QAAG6D,YAAYS,eAAf,EAA+B;AAC3BtE,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,UAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;;AAED,QAAIuE,WAAW,EAAf;AACA,QAAG7E,YAAYwE,IAAZ,CAAiB9B,IAAjB,CAAH,EAA0B;AACtBmC,iBAASJ,KAAT,GAAiB/B,IAAjB;AACH,KAFD,MAEM,IAAGzC,YAAYuE,IAAZ,CAAiB9B,IAAjB,CAAH,EAA0B;AAC5BmC,iBAASH,KAAT,GAAiBhC,IAAjB;AACH,KAFK,MAED;AACDmC,iBAASnC,IAAT,GAAgBA,IAAhB;AACH;AACDlD,UAAMyC,OAAN,CAAc4C,QAAd,EAAwBjD,IAAxB,CAA6B,oBAAU;AACnC,YAAG+C,QAAH,EAAY;AACRrE,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaO,EAAb,GAAkB,KAAlB;AACAP,yBAAaM,GAAb,GAAmB,cAAnB;AACAN,yBAAaQ,IAAb,GAAoB,IAApB;AACAL,gBAAIiB,IAAJ,CAASpB,YAAT;AACH,SAND,MAMK;AACD,gBAAIwE,SAAS1F,MAAb;AACA,gBAAImF,OAAO;AACP7B,sBAAK,EADE;AAEPgC,uBAAQ,EAFD;AAGPD,uBAAQ,EAHD;AAIPN,0BAAS,EAJF;AAKP/E,sBAAO,EALA;AAMP2F,qBAAK,CANE;AAOPC,sBAAM,EAPC;AAQPC,wBAAQ,EARD;AASPC,oBAAI,EATG;AAUPC,wBAAQ,EAVD;AAWPC,2BAAU,EAXH;AAYPC,yBAAS,EAZF;AAaPC,2BAAY,EAbL;AAcPC,yBAAU,CAdH;AAePC,0BAAWvG,cAAcwG,MAAd,CAAqB,IAAIrF,IAAJ,EAArB,EAAgC,sBAAhC,CAfJ;AAgBP+B,uBAAQ;AAhBD,aAAX;AAkBA,gBAAGnC,YAAYwE,IAAZ,CAAiB9B,IAAjB,CAAH,EAA0B;AACtB6B,qBAAKE,KAAL,GAAa/B,IAAb;AACA6B,qBAAKmB,IAAL,GAAY,CAAZ;AACH,aAHD,MAGM,IAAGzF,YAAYuE,IAAZ,CAAiB9B,IAAjB,CAAH,EAA0B;AAC5B6B,qBAAKG,KAAL,GAAahC,IAAb;AACA6B,qBAAKmB,IAAL,GAAY,CAAZ;AACH,aAHK,MAGD;AACDnB,qBAAK7B,IAAL,GAAYA,IAAZ;AACA6B,qBAAKmB,IAAL,GAAY,CAAZ;AACH;AACDnB,iBAAK7B,IAAL,GAAYA,IAAZ;AACA6B,iBAAKnF,IAAL,GAAY0F,MAAZ;AACAP,iBAAKJ,QAAL,GAAgBnF,IAAImF,WAASW,MAAb,CAAhB;AACA,gBAAIa,WAAW,IAAInG,KAAJ,CAAU+E,IAAV,CAAf;AACA,mBAAOoB,SAAShC,IAAT,EAAP;AACH;AACJ,KA3CD,EA2CG/B,IA3CH,CA2CQ,iBAAS;AACb,YAAInC,IAAJ,CAAS;AACLsC,iBAAK6D,MAAM1D,GADN;AAELQ,kBAAM,IAFD;AAGLmD,oBAAQ,EAHH;AAILC,sBAAU,EAJL;AAKLN,sBAAU,IAAIpF,IAAJ,EALL;AAML+B,mBAAO;AANF,SAAT,EAOGwB,IAPH;AAQA,YAAGiC,KAAH,EAAS;AACLtF,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaO,EAAb,GAAkB,IAAlB;AACAP,yBAAaM,GAAb,GAAmB,MAAnB;AACAN,yBAAaQ,IAAb,GAAoB,EAAC0C,IAAGoC,MAAM1D,GAAV,EAApB;AACAzB,gBAAIiB,IAAJ,CAASpB,YAAT;AACH,SAND,MAMK;AACDA,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaO,EAAb,GAAkB,IAAlB;AACAP,yBAAaM,GAAb,GAAmB,MAAnB;AACAN,yBAAaQ,IAAb,GAAoB,IAApB;AACAL,gBAAIiB,IAAJ,CAASpB,YAAT;AACH;AACJ,KAjED;AAkEH,CA1GD;;AA4GAhB,OAAOyB,GAAP,CAAW,UAAX,EAAsB,UAACP,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AAClCF,QAAIgB,OAAJ,CAAYoC,GAAZ,CAAgB,OAAhB,EAAwB,EAAxB;AACApD,QAAIgB,OAAJ,CAAYoC,GAAZ,CAAgB,KAAhB,EAAsB,EAAtB;AACApD,QAAIiB,KAAJ,GAAY,EAAZ;AACAjB,QAAImE,QAAJ,GAAe,IAAf;AACAlE,QAAIsF,QAAJ,CAAa,GAAb,EAAiB,QAAjB;AACH,CAND;;AAQAzG,OAAO2E,IAAP,CAAY,kBAAZ,EAA+B,UAACzD,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AAC3C,QAAIe,QAAQjB,IAAI0D,IAAJ,CAASzC,KAArB;AACA,QAAIM,MAAMvB,IAAI0D,IAAJ,CAASnC,GAAnB;AACA,QAAIiE,kBAAkB;AAClBhB,cAAMxE,IAAI0D,IAAJ,CAASc,IADG;AAElBN,eAAOlE,IAAI0D,IAAJ,CAASQ,KAFE;AAGlBD,eAAOjE,IAAI0D,IAAJ,CAASO,KAHE;AAIlBc,iBAAS/E,IAAI0D,IAAJ,CAASqB,OAJA;AAKlBJ,gBAAQ3E,IAAI0D,IAAJ,CAASiB,MALC;AAMlBD,YAAG1E,IAAI0D,IAAJ,CAASgB,EANM;AAOlBD,gBAAOzE,IAAI0D,IAAJ,CAASe;AAPE,KAAtB;AASA,QAAGxD,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACD,QAAGE,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,KAAhB,KAA0B,EAA1B,IAAgCP,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,OAAhB,KAA4B,EAA/D,EAAkE;AAC9DT,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,KAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACDd,UAAMyG,MAAN,CAAa,EAAC/D,KAAIH,GAAL,EAAb,EAAuBiE,eAAvB,EAAuC,EAACE,OAAM,KAAP,EAAvC,EAAqD,UAAC9E,GAAD,EAAK0B,IAAL,EAAY;AAC7D,YAAG1B,GAAH,EAAQ,MAAMC,QAAQ8E,GAAR,CAAY/E,GAAZ,CAAN;AACRd,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,YAAnB;AACAN,qBAAaQ,IAAb,GAAoB,EAApB;AACAL,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAPD;AAQH,CAhCD;;AAkCAhB,OAAO2E,IAAP,CAAY,gBAAZ,EAA6B,UAACzD,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AACzC,QAAIe,QAAQjB,IAAI0D,IAAJ,CAASzC,KAArB;AACA,QAAIM,MAAMvB,IAAI0D,IAAJ,CAASnC,GAAnB;AACA,QAAIqE,gBAAgB;AAChBrB,aAAIvE,IAAI0D,IAAJ,CAASa,GADG;AAEhBO,mBAAU9E,IAAI0D,IAAJ,CAASoB,SAFH;AAGhBD,iBAAQ7E,IAAI0D,IAAJ,CAASmB;AAHD,KAApB;AAKA,QAAG5D,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACD,QAAGE,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,KAAhB,KAA0B,EAA1B,IAAgCP,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,OAAhB,KAA4B,EAA/D,EAAkE;AAC9DT,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,KAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACDd,UAAMyG,MAAN,CAAa,EAAC/D,KAAIH,GAAL,EAAb,EAAuBqE,aAAvB,EAAqC,EAACF,OAAM,KAAP,EAArC,EAAmD,UAAC9E,GAAD,EAAK0B,IAAL,EAAY;AAC3D,YAAG1B,GAAH,EAAQ,MAAMC,QAAQ8E,GAAR,CAAY/E,GAAZ,CAAN;AACRd,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,YAAnB;AACAN,qBAAaQ,IAAb,GAAoB,EAApB;AACAL,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAPD;AAQH,CA5BD;;AA8BAhB,OAAO2E,IAAP,CAAY,eAAZ,EAA4B,UAACzD,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AACxC,QAAIe,QAAQjB,IAAI0D,IAAJ,CAASzC,KAArB;AACA,QAAIM,MAAMvB,IAAI0D,IAAJ,CAASnC,GAAnB;AACA,QAAIsE,eAAe;AACfC,sBAAa9F,IAAI0D,IAAJ,CAASoC,YADP;AAEfC,oBAAW/F,IAAI0D,IAAJ,CAASqC;AAFL,KAAnB;AAIA,QAAG9E,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACD,QAAGE,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,KAAhB,KAA0B,EAA1B,IAAgCP,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,OAAhB,KAA4B,EAA/D,EAAkE;AAC9DT,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,KAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACDd,UAAMyG,MAAN,CAAa,EAAC/D,KAAIH,GAAL,EAAb,EAAuBsE,YAAvB,EAAoC,EAACH,OAAM,KAAP,EAApC,EAAkD,UAAC9E,GAAD,EAAK0B,IAAL,EAAY;AAC1D,YAAG1B,GAAH,EAAQ,MAAMC,QAAQ8E,GAAR,CAAY/E,GAAZ,CAAN;AACRd,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,QAAnB;AACAN,qBAAaQ,IAAb,GAAoB,EAApB;AACAL,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAPD;AAQH,CA3BD;;AA6BAhB,OAAO2E,IAAP,CAAY,cAAZ,EAA2B,UAACzD,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AACvC,QAAIe,QAAQjB,IAAI0D,IAAJ,CAASzC,KAArB;AACA,QAAI+B,KAAKhD,IAAI0D,IAAJ,CAASV,EAAlB;AACA,QAAIgD,WAAWhG,IAAI0D,IAAJ,CAASsC,QAAxB;AACA,QAAIC,eAAejG,IAAI0D,IAAJ,CAASwC,YAAT,GAAwBlG,IAAI0D,IAAJ,CAASwC,YAAjC,GAA8C,IAAjE;AACA,QAAIC,QAAQnG,IAAI0D,IAAJ,CAASyC,KAArB;AACA,QAAGlF,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACD,QAAIsG,eAAe;AACfJ,kBAASA,QADM;AAEfG,eAAMA;AAFS,KAAnB;AAIA,QAAGF,YAAH,EAAgB;AACZG,qBAAaH,YAAb,GAA4BA,YAA5B;AACH;AACD/G,aAASuG,MAAT,CAAgB,EAAC/D,KAAIsB,EAAL,EAAhB,EAAyBoD,YAAzB,EAAsC,EAACV,OAAM,KAAP,EAAtC,EAAoD,UAAC9E,GAAD,EAAK0B,IAAL,EAAY;AAC5D,YAAG1B,GAAH,EAAQ,MAAMC,QAAQ8E,GAAR,CAAY/E,GAAZ,CAAN;AACRd,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,QAAnB;AACAN,qBAAaQ,IAAb,GAAoB,EAApB;AACAL,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAPD;AAQH,CA3BD;;AA6BAhB,OAAOyB,GAAP,CAAW,sBAAX,EAAkC,UAACP,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AAC9C,QAAIqB,MAAMvB,IAAIwB,KAAJ,CAAUD,GAAV,GAAgBvB,IAAIwB,KAAJ,CAAUD,GAA1B,GAAgCvB,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,KAAhB,CAA1C;AACA,QAAIU,QAAQjB,IAAIwB,KAAJ,CAAUP,KAAtB;AACA,QAAGM,OAAO,EAAV,EAAa;AACTzB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,KAAlB;AACAP,qBAAaM,GAAb,GAAmB,KAAnB;AACAN,qBAAaQ,IAAb,GAAoB,EAApB;AACAL,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACD,QAAGmB,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACD,QAAIuG,cAAcnH,SAASiC,IAAT,CAAc,EAACI,KAAIA,GAAL,EAAd,EAAyBH,IAAzB,CAA8B,oBAAU;AACtD,eAAO2B,QAAP;AACH,KAFiB,CAAlB;AAGA,QAAIuD,UAAUzG,mBAAiB,GAAjB,GAAqB0B,GAAnC;AACAjD,OAAGiI,MAAH,CAAUD,OAAV,EAAkB,kBAAS;AAAE;AACzB,YAAI,CAACC,MAAL,EAAa;AACTjI,eAAGkI,KAAH,CAASF,OAAT,EAAkB,eAAO;AACrB,oBAAI1F,GAAJ,EAAS,MAAMC,QAAQ8E,GAAR,CAAY/E,GAAZ,CAAN;AACZ,aAFD;AAGH;AACDyF,oBAAYjF,IAAZ,CAAiB,eAAK;AAClBmB,gBAAIkE,OAAJ,CAAY,mBAAS;AACjBnI,mBAAGoI,SAAH,CAAa,4CAA0CnF,GAA1C,GAA8C,GAA9C,GAAkD0B,QAAQkD,KAA1D,GAAgE,KAA7E,EAAmFlD,QAAQgD,YAA3F,EAAwG,MAAxG,EAA+G,eAAK;AAChH,wBAAIrF,GAAJ,EAAS,MAAMA,GAAN;AACZ,iBAFD;AAGH,aAJD;AAKAvC,iBAAK,cAAYiI,OAAZ,GAAoB,SAApB,GAA8B,GAA9B,GAAkCA,OAAvC,EAA+C,EAACK,UAAS,MAAV,EAAiBC,WAAUnE,SAAS,MAAI,IAAb,CAA3B,EAA/C,EAA8F,UAAC3B,KAAD,EAAO+F,MAAP,EAAcC,MAAd,EAAuB;AACjH,oBAAGhG,KAAH,EAAU,MAAMA,KAAN;AACVhB,6BAAaK,IAAb,GAAoB,CAApB;AACAL,6BAAaO,EAAb,GAAkB,IAAlB;AACAP,6BAAaM,GAAb,GAAmB,YAAnB;AACAN,6BAAaQ,IAAb,GAAoB,EAACyG,UAAS,wCAAsCxF,GAAtC,GAA0C,SAApD,EAApB;AACAtB,oBAAIiB,IAAJ,CAASpB,YAAT;AACH,aAPD;AAQH,SAdD;AAeH,KArBD;AAsBH,CA3CD;;AA6CAhB,OAAO2E,IAAP,CAAY,cAAZ,EAA2B,UAACzD,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AACvC,QAAIqB,MAAMvB,IAAI0D,IAAJ,CAASnC,GAAnB;AACA,QAAIW,OAAOlC,IAAI0D,IAAJ,CAASxB,IAApB;AACA,QAAII,OAAO,IAAIrD,IAAJ,CAAS;AAChBsC,aAAIA,GADY;AAEhBW,cAAMA,IAFU;AAGhBmD,gBAAQ,EAHQ;AAIhBC,kBAAU,EAJM;AAKhBN,kBAAUvG,cAAcwG,MAAd,CAAqB,IAAIrF,IAAJ,EAArB,EAAgC,sBAAhC,CALM;AAMhB+B,eAAO;AANS,KAAT,CAAX;AAQAW,SAAKa,IAAL,GAAY/B,IAAZ,CAAiB,kBAAQ;AACrBtB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,QAAnB;AACAN,qBAAaQ,IAAb,GAAoB,EAAC0C,IAAGgE,OAAOtF,GAAX,EAApB;AACAzB,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAND;AAOH,CAlBD;;AAoBAhB,OAAO2E,IAAP,CAAY,qBAAZ,EAAkC,UAACzD,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AAC9C,QAAIqB,MAAMvB,IAAI0D,IAAJ,CAASnC,GAAnB;AACA,QAAIyB,KAAKhD,IAAI0D,IAAJ,CAASV,EAAlB;AACA,QAAI/B,QAAQjB,IAAI0D,IAAJ,CAASzC,KAArB;AACA,QAAIiB,OAAOlC,IAAI0D,IAAJ,CAASxB,IAApB;AACA,QAAGjB,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACDb,SAAKwG,MAAL,CAAY,EAAC/D,KAAIsB,EAAL,EAAQzB,KAAIA,GAAZ,EAAZ,EAA6B,EAACW,MAAKA,IAAN,EAA7B,EAAyC,EAACwD,OAAM,KAAP,EAAzC,EAAuD,UAAC9E,GAAD,EAAK0B,IAAL,EAAY;AAC/D,YAAG1B,GAAH,EAAQ,MAAMC,QAAQ8E,GAAR,CAAY/E,GAAZ,CAAN;AACRd,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,UAAnB;AACAN,qBAAaQ,IAAb,GAAoB,EAApB;AACAL,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAPD;AAQH,CAnBD;;AAqBAhB,OAAO2E,IAAP,CAAY,aAAZ,EAA0B,UAACzD,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AACtC,QAAIqB,MAAMvB,IAAI0D,IAAJ,CAASnC,GAAnB;AACA,QAAIuB,SAAS9C,IAAI0D,IAAJ,CAASZ,MAAtB;AACA,QAAImE,WAAWjH,IAAI0D,IAAJ,CAASuD,QAAxB;AACA,QAAIC,YAAYlH,IAAI0D,IAAJ,CAASwD,SAAzB;AACA,QAAIjG,QAAQjB,IAAI0D,IAAJ,CAASzC,KAArB;AACA,QAAGA,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACD,QAAImD,UAAU,IAAI/D,QAAJ,CAAa;AACvBqC,aAAKA,GADkB;AAEvBuB,gBAAOA,MAFgB,EAEP;AAChBmE,kBAASA,QAHc,EAGJ;AACnBE,gBAAQD,SAJe,EAIJ;AACnBf,eAAO1H,cAAcwG,MAAd,CAAqB,IAAIrF,IAAJ,EAArB,EAAgC,aAAhC,CALgB,EAKgC;AACvD0F,kBAAU,EANa,EAMT;AACdD,gBAAQ,EAPe,EAOX;AACZW,kBAAU,EARa,EAQT;AACd9C,eAAO,CATgB;AAUvBkE,eAAO,CAVgB;AAWvBC,cAAM,CAXiB;AAYvBrC,kBAAUvG,cAAcwG,MAAd,CAAqB,IAAIrF,IAAJ,EAArB,EAAgC,sBAAhC,CAZa;AAavB0H,mBAAW,CAbY;AAcvB3F,eAAO;AAdgB,KAAb,CAAd;AAgBAsB,YAAQE,IAAR,GAAe/B,IAAf,CAAoB,kBAAS;AACzBtB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,QAAnB;AACAN,qBAAaQ,IAAb,GAAoB,EAAC0C,IAAGgE,OAAOtF,GAAX,EAApB;AACAzB,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAND;AAOH,CAnCD;;AAqCAhB,OAAOyB,GAAP,CAAW,YAAX,EAAwB,UAACP,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AACpC,QAAIqB,MAAMvB,IAAIwB,KAAJ,CAAUD,GAApB;AACA,QAAIyB,KAAKhD,IAAIwB,KAAJ,CAAUwB,EAAnB;AACA,QAAI/B,QAAQjB,IAAIwB,KAAJ,CAAUP,KAAtB;AACA,QAAGA,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACDb,SAAKwG,MAAL,CAAY,EAAC/D,KAAIsB,EAAL,EAAQzB,KAAIA,GAAZ,EAAZ,EAA8B,EAACI,OAAM,CAAP,EAA9B,EAAyC,EAAC+D,OAAM,KAAP,EAAzC,EAAwD,UAAC9E,GAAD,EAAK0B,IAAL,EAAY;AAChE,YAAG1B,GAAH,EAAQ,MAAMC,QAAQ8E,GAAR,CAAY/E,GAAZ,CAAN;AACRd,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,QAAnB;AACAN,qBAAaQ,IAAb,GAAoB,EAApB;AACAL,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAPD;AAQH,CAlBD;;AAoBAhB,OAAOyB,GAAP,CAAW,iBAAX,EAA6B,UAACP,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAiB;AAC1C,QAAIqB,MAAMvB,IAAIwB,KAAJ,CAAUD,GAApB;AACA,QAAIyB,KAAKhD,IAAIwB,KAAJ,CAAUwB,EAAnB;AACA,QAAI/B,QAAQjB,IAAIwB,KAAJ,CAAUP,KAAtB;AACA,QAAIA,SAAS,EAAb,EAAiB;AACbnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACDZ,aAASuG,MAAT,CAAgB,EAAC/D,KAAKsB,EAAN,EAAUzB,KAAKA,GAAf,EAAhB,EAAqC,EAAC+F,WAAW,CAAZ,EAArC,EAAqD,EAAC5B,OAAO,KAAR,EAArD,EAAqE,UAAC9E,GAAD,EAAM0B,IAAN,EAAe;AAChF,YAAI1B,GAAJ,EAAS,MAAMC,QAAQ8E,GAAR,CAAY/E,GAAZ,CAAN;AACTd,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,OAAnB;AACAN,qBAAaQ,IAAb,GAAoB,EAApB;AACAL,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAPD;AAQH,CAlBD;;AAoBAhB,OAAOyB,GAAP,CAAW,gBAAX,EAA4B,UAACP,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AACxC,QAAIqB,MAAMvB,IAAIwB,KAAJ,CAAUD,GAApB;AACA,QAAIyB,KAAKhD,IAAIwB,KAAJ,CAAUwB,EAAnB;AACA,QAAI/B,QAAQjB,IAAIwB,KAAJ,CAAUP,KAAtB;AACA,QAAGA,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACDZ,aAASuG,MAAT,CAAgB,EAAC/D,KAAIsB,EAAL,EAAQzB,KAAIA,GAAZ,EAAhB,EAAkC,EAACI,OAAM,CAAP,EAAlC,EAA6C,EAAC+D,OAAM,KAAP,EAA7C,EAA4D,UAAC9E,GAAD,EAAK0B,IAAL,EAAY;AACpE,YAAG1B,GAAH,EAAQ,MAAMC,QAAQ8E,GAAR,CAAY/E,GAAZ,CAAN;AACRd,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,QAAnB;AACAN,qBAAaQ,IAAb,GAAoB,EAApB;AACAL,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAPD;AAQH,CAlBD;;AAoBAhB,OAAO2E,IAAP,CAAY,oBAAZ,EAAiC,UAACzD,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AAC7C,QAAIqB,MAAMvB,IAAI0D,IAAJ,CAASnC,GAAnB;AACA,QAAIN,QAAQjB,IAAI0D,IAAJ,CAASzC,KAArB;AACA,QAAI+B,KAAKhD,IAAI0D,IAAJ,CAASV,EAAlB;AACA,QAAImD,QAAQnG,IAAI0D,IAAJ,CAASyC,KAArB;AACA,QAAGlF,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACDZ,aAASuG,MAAT,CAAgB,EAAC/D,KAAIsB,EAAL,EAAQzB,KAAIA,GAAZ,EAAhB,EAAkC,EAAC4E,OAAMA,KAAP,EAAlC,EAAiD,EAACT,OAAM,KAAP,EAAjD,EAA+D,UAAC9E,GAAD,EAAK0B,IAAL,EAAY;AACvE,YAAG1B,GAAH,EAAQ,MAAMC,QAAQ8E,GAAR,CAAY/E,GAAZ,CAAN;AACRd,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,QAAnB;AACAN,qBAAaQ,IAAb,GAAoB,EAApB;AACAL,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAPD;AAQH,CAnBD;;AAqBAhB,OAAO2E,IAAP,CAAY,cAAZ,EAA2B,UAACzD,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AACvC,QAAI8C,KAAKhD,IAAI0D,IAAJ,CAASV,EAAlB;AACA,QAAIgD,WAAWhG,IAAI0D,IAAJ,CAASsC,QAAxB;AACA,QAAIzE,MAAMvB,IAAI0D,IAAJ,CAASnC,GAAnB;AACA,QAAIN,QAAQjB,IAAI0D,IAAJ,CAASzC,KAArB;AACA,QAAGA,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACD,QAAGE,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,KAAhB,KAA0B,EAA1B,IAAgCP,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,OAAhB,KAA4B,EAA/D,EAAkE;AAC9DT,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,OAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACDZ,aAASuC,OAAT,CAAiB,EAACC,KAAIsB,EAAL,EAAjB,EAA2B5B,IAA3B,CAAgC,mBAAS;AACrC,YAAId,OAAO;AACPiB,iBAAKA,GADE,EACM;AACbgC,wBAAYN,QAAQvB,GAFb,EAEkB;AACzB6F,yBAAatE,QAAQ1B,GAHd,EAGmB;AAC1ByE,sBAAUA,QAJH,EAIe;AACtBhB,sBAAU,IAAIpF,IAAJ,EALH,EAKmB;AAC1B+B,mBAAO;AANA,SAAX;AAQA,YAAIxC,OAAJ,CAAYmB,IAAZ,EAAkB6C,IAAlB;AACArD,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,MAAnB;AACAN,qBAAaQ,IAAb,GAAoB,EAApB;AACAL,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAfD;AAgBH,CAjCD;;AAmCAhB,OAAOyB,GAAP,CAAW,aAAX,EAAyB,UAACP,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AACrC,QAAI8C,KAAGhD,IAAIwB,KAAJ,CAAUwB,EAAjB;AACA,QAAI/B,QAAQjB,IAAIwB,KAAJ,CAAUP,KAAtB;AACA9B,YAAQgC,IAAR,CAAa,EAACoC,YAAWP,EAAZ,EAAb,EAA8B5B,IAA9B,CAAmC,mBAAS;AACxC,YAAG,CAACoC,OAAJ,EAAa,MAAM3C,QAAQ8E,GAAR,CAAYnC,OAAZ,CAAN;AACb1D,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,SAAnB;AACAN,qBAAaQ,IAAb,GAAoBkD,OAApB;AACAvD,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAPD;AAQH,CAXD;;AAaAhB,OAAO2E,IAAP,CAAY,WAAZ,EAAwB/D,SAAS8H,MAAT,CAAgB,qBAAhB,CAAxB,EAA+D,UAACxH,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AAC3E;AACA,QAAIuH,MAAMzH,IAAI0H,IAAJ,CAASC,QAAT,CAAkBC,KAAlB,CAAwB,GAAxB,EAA6B,CAA7B,CAAV;AACA,QAAIC,WAAWpJ,cAAcwG,MAAd,CAAqB,IAAIrF,IAAJ,EAArB,EAAgC,iBAAhC,IAAmD,GAAnD,GAAuDf,WAAvD,GAAmE,GAAnE,GAAuE4I,GAAtF;AACA,QAAIK,YAAYrJ,cAAcwG,MAAd,CAAqB,IAAIrF,IAAJ,EAArB,EAAgC,WAAhC,CAAhB;AACA,QAAI0G,UAAU,yDAAuDwB,SAAvD,GAAiE,GAA/E;;AAEAxJ,OAAGiI,MAAH,CAAUD,OAAV,EAAkB,kBAAQ;AAAE;AACxB,YAAG,CAACC,MAAJ,EAAW;AACPjI,eAAGkI,KAAH,CAASF,OAAT,EAAiB,eAAK;AAClB,oBAAG,CAAC1F,GAAJ,EAAS,MAAMC,QAAQ8E,GAAR,CAAY/E,GAAZ,CAAN;AACZ,aAFD;AAGH;AACDtC,WAAGoI,SAAH,CAAaJ,UAAQuB,QAArB,EAA8B7H,IAAI0H,IAAJ,CAASK,MAAvC,EAA8C,eAAK;AAC/C,gBAAG,CAACnH,GAAJ,EAAQ;AACJ,oBAAItB,MAAJ,CAAW;AACP0I,kCAAahI,IAAI0H,IAAJ,CAASM,YADf;AAEPH,8BAAUA,QAFH;AAGPI,0BAAM3B,OAHC;AAIP4B,8BAAU5B,UAAQuB,QAJX;AAKPlB,8BAAU3G,IAAI0H,IAAJ,CAASf,QALZ;AAMPgB,8BAAU3H,IAAI0H,IAAJ,CAASC,QANZ;AAOPQ,0BAAMnI,IAAI0H,IAAJ,CAASS,IAPR;AAQPnD,8BAAU,IAAIpF,IAAJ,EARH;AASP+B,2BAAO;AATA,iBAAX,EAUGwB,IAVH,GAUU/B,IAVV,CAUe,kBAAQ;AACnB,wBAAG,CAAC4F,MAAJ,EAAY,MAAMnG,QAAQ8E,GAAR,CAAYqB,MAAZ,CAAN;AACZ/G,wBAAIiB,IAAJ,CAAS;AACLkH,iCAAQ,QADH;AAELC,6BAAI,sDAAoDP,SAApD,GAA8D,GAA9D,GAAkED,QAFjE;AAGLS,iCAAQ;AAHH,qBAAT;AAKH,iBAjBD;AAkBH;AACJ,SArBD;AAsBH,KA5BD;AA6BH,CApCD;;AAsCAxJ,OAAO2E,IAAP,CAAY,iBAAZ,EAA8B,UAACzD,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AAC1C,QAAIqB,MAAMvB,IAAI0D,IAAJ,CAASnC,GAAnB;AACA,QAAIN,QAAQjB,IAAI0D,IAAJ,CAASzC,KAArB;AACA,QAAIsH,OAAOvI,IAAI0D,IAAJ,CAAS6E,IAApB;AACA,QAAIrG,OAAOlC,IAAI0D,IAAJ,CAASxB,IAApB;AACA,QAAIoD,WAAWtF,IAAI0D,IAAJ,CAAS4B,QAAxB;AACA,QAAIkD,OAAOxI,IAAI0D,IAAJ,CAAS8E,IAApB;AACA,QAAIC,SAASzI,IAAI0D,IAAJ,CAAS+E,MAAtB;AACA,QAAIC,SAAS1I,IAAI0D,IAAJ,CAASgF,MAAtB;AACA,QAAGzH,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACD,QAAI6I,cAAc,IAAIpJ,WAAJ,CAAgB;AAC9BgC,aAAKA,GADyB;AAE9BW,cAAMA,IAFwB,EAER;AACtBgD,cAAM,CAHwB,EAGX;AACnBqD,cAAMA,IAJwB,EAIR;AACtBjD,kBAAUA,QALoB,EAKJ;AAC1BN,kBAAW,IAAIpF,IAAJ,EANmB,EAMA;AAC9B6I,gBAAQA,MAPsB,EAON;AACxBD,cAAMA,IARwB,EAQR;AACtBI,gBAAO,CATuB,EASN;AACxBC,mBAAU,EAVoB;AAW9BC,iBAAQ,CAXsB,EAWN;AACxBC,qBAAY,EAZkB;AAa9BL,gBAAQA,MAbsB,EAaL;AACzB/G,eAAQ;AAdsB,KAAhB,CAAlB;AAgBAgH,gBAAYxF,IAAZ,GAAmB/B,IAAnB,CAAwB,gBAAM;AAC1B,YAAG,CAAC4H,IAAJ,EAAU;AACNlJ,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaO,EAAb,GAAkB,KAAlB;AACAP,yBAAaM,GAAb,GAAmB,QAAnB;AACAN,yBAAaQ,IAAb,GAAoB,EAApB;AACAL,gBAAIiB,IAAJ,CAASpB,YAAT;AACH,SAND,MAMK;AACDA,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaO,EAAb,GAAkB,IAAlB;AACAP,yBAAaM,GAAb,GAAmB,QAAnB;AACAN,yBAAaQ,IAAb,GAAoB0I,IAApB;AACA/I,gBAAIiB,IAAJ,CAASpB,YAAT;AACH;AAEJ,KAfD;AAgBH,CA/CD;;AAiDAhB,OAAOyB,GAAP,CAAW,kBAAX,EAA8B,UAACP,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AAC1C,QAAIqB,MAAMvB,IAAIwB,KAAJ,CAAUD,GAApB;AACA,QAAIN,QAAQjB,IAAIwB,KAAJ,CAAUP,KAAtB;AACA,QAAIuB,SAASxC,IAAIwB,KAAJ,CAAUgB,MAAV,GAAmBC,SAASzC,IAAIwB,KAAJ,CAAUgB,MAAnB,CAAnB,GAAgD,CAA7D;AACA,QAAIE,MAAM1C,IAAIwB,KAAJ,CAAUkB,GAAV,GAAgBD,SAASzC,IAAIwB,KAAJ,CAAUkB,GAAnB,CAAhB,GAA0C,EAApD;AACA,QAAIL,QAAQd,QAAQ,KAAK,CAAb,GAAkB,EAACI,OAAM,CAAP,EAASJ,KAAIA,GAAb,EAAlB,GAAsC,EAACI,OAAM,CAAP,EAAlD;AACApC,gBAAY4B,IAAZ,CAAiBkB,KAAjB,EAAwBM,IAAxB,CAA6B,CAACH,UAAU,CAAV,GAAcA,MAAd,GAAuBA,SAAO,CAA/B,IAAmCE,GAAhE,EAAqEE,KAArE,CAA2EF,GAA3E,EAAgFtB,IAAhF,CAAqF,iBAAO;AACxF,YAAG,CAAC6H,KAAJ,EAAW,MAAMpI,QAAQ8E,GAAR,CAAYsD,KAAZ,CAAN;AACXnJ,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,SAAnB;AACAN,qBAAaQ,IAAb,GAAoB2I,KAApB;AACAhJ,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAPD;AAQH,CAdD;;AAgBAhB,OAAOyB,GAAP,CAAW,oBAAX,EAAgC,UAACP,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AAC5C,QAAI8C,KAAKhD,IAAIwB,KAAJ,CAAUwB,EAAnB;AACA,QAAI/B,QAAQjB,IAAIwB,KAAJ,CAAUP,KAAtB;AACA,QAAIiI,aAAa,EAAjB;AACA3J,gBAAYkC,OAAZ,CAAoB,EAACC,KAAIsB,EAAL,EAApB,EAA8B5B,IAA9B,CAAmC,gBAAM;AACrC,YAAG,CAAC4H,IAAJ,EAAU,MAAMnI,QAAQ8E,GAAR,CAAYqD,IAAZ,CAAN;AACVlJ,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,SAAnB;AACAN,qBAAaQ,IAAb,GAAoB0I,IAApB;AACA/I,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAPD;AAQH,CAZD;;AAcAhB,OAAOyB,GAAP,CAAW,mBAAX,EAA+B,UAACP,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AAC3C,QAAIqB,MAAMvB,IAAIwB,KAAJ,CAAUD,GAApB;AACA,QAAIyB,KAAKhD,IAAIwB,KAAJ,CAAUwB,EAAnB;AACA,QAAI/B,QAAQjB,IAAIwB,KAAJ,CAAUP,KAAtB;AACA,QAAGA,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACDP,gBAAYkC,OAAZ,CAAoB,EAACC,KAAIsB,EAAL,EAApB,EAA8B5B,IAA9B,CAAmC,gBAAM;AACrC4H,aAAKJ,MAAL;AACAI,aAAKH,SAAL,CAAeL,IAAf,CAAoB,EAACjH,KAAIA,GAAL,EAApB;AACAyH,aAAK7F,IAAL;AACArD,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KARD;AASH,CAnBD;;AAqBAhB,OAAOyB,GAAP,CAAW,cAAX,EAA0B,UAACP,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AACtC,QAAIqB,MAAMvB,IAAIwB,KAAJ,CAAUD,GAApB;AACA,QAAIyB,KAAKhD,IAAIwB,KAAJ,CAAUwB,EAAnB;AACA,QAAIO,aAAavD,IAAIwB,KAAJ,CAAU+B,UAA3B;AACA,QAAItC,QAAQjB,IAAIwB,KAAJ,CAAUP,KAAtB;AACA,QAAGA,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACDP,gBAAYkC,OAAZ,CAAoB,EAACC,KAAIsB,EAAL,EAApB,EAA8B5B,IAA9B,CAAmC,gBAAM;AACrC4H,aAAKF,OAAL;AACA,YAAGE,KAAKD,WAAL,CAAiBI,MAAjB,GAA0B,CAA7B,EAA+B;AAC3BH,iBAAKD,WAAL,CAAiBtC,OAAjB,CAAyB,eAAK;AAC1B,oBAAG2C,IAAIpG,EAAJ,IAAUO,UAAb,EAAwB;AACpBzD,iCAAaK,IAAb,GAAoB,CAApB;AACAL,iCAAaO,EAAb,GAAkB,KAAlB;AACAP,iCAAaM,GAAb,GAAmB,mBAAnB;AACAH,wBAAIiB,IAAJ,CAASpB,YAAT;AACH,iBALD,MAKK;AACDkJ,yBAAKD,WAAL,CAAiBP,IAAjB,CAAsB,EAACxF,IAAGO,UAAJ,EAAtB;AACAyF,yBAAK7F,IAAL;AACArD,iCAAaK,IAAb,GAAoB,CAApB;AACAL,iCAAaO,EAAb,GAAkB,IAAlB;AACAP,iCAAaM,GAAb,GAAmB,MAAnB;AACAH,wBAAIiB,IAAJ,CAASpB,YAAT;AACH;AACD;AACH,aAfD;AAgBH,SAjBD,MAiBK;AACDkJ,iBAAKD,WAAL,CAAiBP,IAAjB,CAAsB,EAACxF,IAAGO,UAAJ,EAAtB;AACAyF,iBAAK7F,IAAL;AACArD,yBAAaK,IAAb,GAAoB,CAApB;AACAL,yBAAaO,EAAb,GAAkB,IAAlB;AACAP,yBAAaM,GAAb,GAAmB,MAAnB;AACAH,gBAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACJ,KA5BD;AA6BH,CAxCD;;AA0CAhB,OAAO2E,IAAP,CAAY,kBAAZ,EAA+B,UAACzD,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AAC3C,QAAIqB,MAAMvB,IAAI0D,IAAJ,CAASnC,GAAnB;AACA,QAAIN,QAAQjB,IAAI0D,IAAJ,CAASzC,KAArB;AACA,QAAI6D,YAAY9E,IAAI0D,IAAJ,CAASoB,SAAzB;AACA,QAAG7D,SAAS,EAAZ,EAAe;AACXnB,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,MAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACD,QAAGE,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,KAAhB,KAA0B,EAA1B,IAAgCP,IAAIgB,OAAJ,CAAYT,GAAZ,CAAgB,OAAhB,KAA4B,EAA/D,EAAkE;AAC9DT,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaM,GAAb,GAAmB,KAAnB;AACAH,YAAIiB,IAAJ,CAASpB,YAAT;AACA;AACH;AACDd,UAAMyG,MAAN,CAAa,EAAC/D,KAAIH,GAAL,EAAb,EAAuB,EAACuD,WAAUA,SAAX,EAAvB,EAA6C,EAACY,OAAM,KAAP,EAA7C,EAA2D,UAAC9E,GAAD,EAAK0B,IAAL,EAAY;AACnE,YAAG1B,GAAH,EAAQ,MAAMC,QAAQ8E,GAAR,CAAY/E,GAAZ,CAAN;AACRd,qBAAaK,IAAb,GAAoB,CAApB;AACAL,qBAAaO,EAAb,GAAkB,IAAlB;AACAP,qBAAaM,GAAb,GAAmB,YAAnB;AACAN,qBAAaQ,IAAb,GAAoB,EAApB;AACAL,YAAIiB,IAAJ,CAASpB,YAAT;AACH,KAPD;AAQH,CAxBD;;AA2BAhB,OAAOyB,GAAP,CAAW,MAAX,EAAkB,UAACP,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAgB;AAC9BD,QAAIiB,IAAJ,CAASlB,IAAIwB,KAAb;AACH,CAFD;;AAIA6H,OAAOC,OAAP,GAAiBxK,MAAjB","file":"api.js","sourcesContent":["const { exec } = require('child_process');\nconst fs = require('fs');\nconst express = require('express');\nconst md5 = require('md5');\nconst sillyDateTime = require('silly-datetime');\nconst multer  = require('multer');\nconst Geetest = require('gt3-sdk');\nconst salt = require('../libs/salt');\nconst crt_token = require('../libs/ctr_token');\nconst router = express.Router();\nconst Users = require('../models/Users_model');\nconst Docs = require('../models/Document_model');\nconst Articles = require('../models/Articles_model');\nconst Discuss = require('../models/Discuss_model');\nconst Tags = require('../models/Tags_model');\nconst Slide = require('../models/Slide_model');\nconst Photos = require('../models/Photos_model');\nconst Collections = require('../models/Collections_model');\nconst emailRegexp = /^[a-z0-9]+([._\\\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/;\nconst phoneRegexp = /^((13[0-9])|(14[5|7])|(15([0-3]|[5-9]))|(18[0,5-9]))\\\\d{8}$/;\nconst uoloader = multer(); //{dest: 'uploads/'}设置dest表示上传文件的目录，如果不设置上传的文件永远在内存之中不会保存到磁盘上。在此处为了在内存中取出文件并重命名所以不设置文件上传路径\nconst NowDate = new Date();\nconst downloadBasecDir = '/Users/bluelife/www/node/blog/download/';\nlet responseData = {};\n\nrouter.use(function(req, res, next) {\n    responseData = {\n        code: 0,\n        msg: '',\n        ok:false,\n        data: null\n    };\n    next();\n});\n\nrouter.get('/gettest',(req,res,next)=>{\n    let captcha = new Geetest({\n        geetest_id: 'e46e906d776dbd41c4e72f72499ca39f',\n        geetest_key: '30b094aad22445378f7fdc01b83215bb'\n    }).register(null,(err,data)=>{\n        if (err) {\n            console.error(err);\n            return;\n        }\n        res.send(data);\n        // console.log(data);\n\n        // if (!data.success) {\n        //     // 进入 fallback，如果一直进入此模式，请检查服务器到极验服务器是否可访问\n        //     // 可以通过修改 hosts 把极验服务器 api.geetest.com 指到不可访问的地址\n        //     // 为以防万一，你可以选择以下两种方式之一：\n        //     // 1. 继续使用极验提供的failback备用方案\n        //     req.session.fallback = true;\n        //     res.send(data);\n        //     // 2. 使用自己提供的备用方案\n        //     // todo\n        // } else {\n        //     // 正常模式\n        //     req.session.fallback = false;\n        //     res.send(data);\n        // }\n    });\n});\n\n/**\n * 获取TOKEN\n */\nrouter.get('/gettoken',(req, res, next)=>{\n    responseData.code = 1;\n    responseData.msg = 'success';\n    responseData.ok = true;\n    if(req.cookies.get('token') && req.cookies.get('token') != ''){\n        responseData.data = {\n            token:req.cookies.get('token')\n        };\n    }else{\n        let token = crt_token();\n        responseData.data = {\n            token:crt_token\n        };\n    }\n    res.json(responseData);\n    return;\n})\n\n/**\n * 获取所有标签\n */\nrouter.get('/tags',(req, res, next)=>{\n    // console.log(Tags);\n    // res.send();\n    Tags.find().then(tags=>{\n        if(tags){\n            responseData.code = 1;\n            responseData.msg = 'success';\n            responseData.ok = true;\n            responseData.data = tags;\n            res.json(responseData);\n            return;\n        }else{\n            responseData.code = 0;\n            responseData.msg = 'error';\n            responseData.ok = false;\n            responseData.data = {};\n            res.json(responseData);\n            return;\n        }\n    });\n});\n\n/**\n * 获取幻灯片\n */\nrouter.get('/slides',(req, res, next)=>{\n    Slide.find().then(slides=>{\n        if(slides){\n            responseData.code = 1;\n            responseData.msg = 'success';\n            responseData.ok = true;\n            responseData.data = slides;\n            res.json(responseData);\n            return;\n        }else{\n            responseData.code = 0;\n            responseData.msg = 'error';\n            responseData.ok = false;\n            responseData.data = {};\n            res.json(responseData);\n            return;\n        }\n    });\n})\n\nrouter.get('/getUsers',(req, res, next)=>{\n    let uid = req.query.uid;\n    Users.findOne({_id:uid, isDel:0}).then(usersInfo=>{\n        if(usersInfo){\n            responseData.code = 1;\n            responseData.msg = 'success';\n            responseData.ok = true;\n            responseData.data = usersInfo;\n            res.json(responseData);\n        }else{\n            responseData.code = 0;\n            responseData.msg = 'error';\n            responseData.ok = false;\n            responseData.data = {};\n            res.json(responseData);\n        }\n    });\n});\n\nrouter.get('/allUsers',(req,res,next)=>{\n    let keyWord = req.query.keyword;\n    const reg = new RegExp(keyWord, 'si') //不区分大小写\n    Users.find({\n        // name:{$regex : /keyWord/,$options: 'si'}\n        $or : [ //多条件，数组\n            {name : {$regex : reg}}\n        ]\n    }).then(users=>{\n        if(users){\n            responseData.code = 1;\n            responseData.msg = 'success';\n            responseData.ok = true;\n            responseData.data = users;\n            res.json(responseData);\n        }else{\n            responseData.code = 0;\n            responseData.msg = 'error';\n            responseData.ok = false;\n            responseData.data = {};\n            res.json(responseData);\n        }\n    });\n})\n\nrouter.get('/getDocLists',(req, res, next)=>{\n    let uid = req.query.uid ? req.query.uid :(req.cookies.get('uid') ? req.cookies.get('uid'): '');\n    let where = uid ? {uid:uid,isDel:0} : {isDel:0};\n    Docs.find(where).then(docs=>{\n        if(docs){\n            responseData.code = 1;\n            responseData.msg = 'success';\n            responseData.ok = true;\n            responseData.data = docs;\n            res.json(responseData);\n        }else{\n            responseData.code = 0;\n            responseData.msg = 'error';\n            responseData.ok = false;\n            responseData.data = {};\n            res.json(responseData);\n        }\n    });\n});\n\nrouter.get('/allArticles',(req, res, next)=>{\n    let uid = '';\n    let all = false;\n    let offset = req.query.offset ? parseInt(req.query.offset) : 0;\n    let num = req.query.num ? parseInt(req.query.num) : 10;\n    if(req.cookies.get('token') && req.cookies.get('uid')){\n        uid = req.cookies.get('uid');\n    }else{\n        all = true;\n    }\n    let where = all ? {isDel:0}: {uid:uid,isDel:0};\n    Articles.find(where).skip((offset == 0 ? offset : (offset-1))).limit(num).then(alls=>{\n        if(alls){\n            responseData.code = 1;\n            responseData.msg = 'success';\n            responseData.ok = true;\n            responseData.data = alls;\n            res.json(responseData);\n        }else{\n            responseData.code = 0;\n            responseData.msg = 'error';\n            responseData.ok = false;\n            responseData.data = {};\n            res.json(responseData);\n        }\n    });\n})\n\nrouter.get('/getArticleLists',(req, res, next)=>{\n    let doc_id = req.query.doc_id;\n    Articles.find({\n        doc_id:doc_id,\n        isDel:0\n    }).then(articles=>{\n        // console.log(articles);\n        if(articles){\n            responseData.code = 1;\n            responseData.msg = 'success';\n            responseData.ok = true;\n            responseData.data = articles;\n            res.json(responseData);\n        }else{\n            responseData.code = 0;\n            responseData.msg = 'error';\n            responseData.ok = false;\n            responseData.data = {};\n            res.json(responseData);\n        }\n    });\n});\n\nrouter.get('/getArticle',(req, res, next)=>{\n    let id = req.query.id;\n    Articles.findOne({_id:id}).then(article=>{\n        if(article){\n            if(!req.cookies.get(id)){\n                //增加阅读数\n                article.watch++;\n                article.save();\n                req.cookies.set(id,'on',{maxAge:1000*3600*10,expires:1000*3600*10});\n            }\n\n            Discuss.find({article_id:article._id}).then(discuss=>{\n                responseData.code = 1;\n                responseData.msg = 'success';\n                responseData.ok = true;\n                responseData.data = {\n                    'article' : article,\n                    'discuss' : discuss\n                };\n                res.json(responseData);\n            });\n\n        }else{\n            responseData.code = 0;\n            responseData.msg = 'error';\n            responseData.ok = false;\n            responseData.data = {};\n            res.json(responseData);\n        }\n    });\n})\n\nrouter.post('/signin', (req, res, next) => {\n    let name = req.body.name;\n    let password = req.body.password;\n    let form = req.body.form;\n    let validateCode = form == 'login' ? req.body.validateCode : '';\n    let remember = req.body.remember;\n    if (name == '') {\n        responseData.code = 0;\n        responseData.msg = '用户名不能为空';\n        res.json(responseData);\n        return;\n    }\n    if (password == '') {\n        responseData.code = 0;\n        responseData.msg = \"密码不能为空\";\n        res.json(responseData);\n        return;\n    }\n    if(form == 'login'){\n        if(validateCode == ''){\n            responseData.code = 0;\n            responseData.msg = \"请先通过验证\";\n            res.json(responseData);\n            return;\n        }\n    }\n    let user = {};\n    if(emailRegexp.test(name)){\n        user.email = name;\n    }else if(phoneRegexp.test(name)){\n        user.phone = name;\n    }else{\n        user.name = name;\n    }\n    Users.findOne(user).then(function(userInfo) {\n        if (userInfo) {\n            if(userInfo.password == md5(password+userInfo.salt)){\n                responseData.code = 1;\n                responseData.msg = \"success\";\n                responseData.ok = true;\n                responseData.data = userInfo;\n                req.cookies.set('uid',userInfo._id,{maxAge:1000*3600*10,expires:1000*3600*10});\n                req.cookies.set('token',crt_token(),{maxAge:1000*3600*10,expires:1000*3600*10});\n                res.json(responseData);\n                return;\n            }else{\n                responseData.code = 2;\n                responseData.msg = \"登录失败，密码不正确\";\n                responseData.ok = false;\n                responseData.data = null;\n                res.json(responseData);\n            }\n        } else {\n            responseData.code = 0;\n            responseData.msg = \"您还没有帐号，请注册帐号\";\n            responseData.data = '';\n            res.json(responseData);\n        }\n    });\n});\n\nrouter.post('/signup',(req, res, next)=>{\n    let name = req.body.name;\n    let phone = req.body.phone;\n    let password = req.body.password;\n    let passwordConfirm = req.body.passwordConfirm;\n    let token = req.body.token;\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    if (name == '') {\n        responseData.code = 0;\n        responseData.msg = '用户名不能为空';\n        res.json(responseData);\n        return;\n    }\n    if (password == '') {\n        responseData.code = 0;\n        responseData.msg = \"密码不能为空\";\n        res.json(responseData);\n        return;\n    }\n\n    if(password != passwordConfirm){\n        responseData.code = 0;\n        responseData.msg = \"两次输入密码不同\";\n        res.json(responseData);\n        return;\n    }\n\n    let findData = {};\n    if(emailRegexp.test(name)){\n        findData.email = name;\n    }else if(phoneRegexp.test(name)){\n        findData.phone = name;\n    }else{\n        findData.name = name;\n    }\n    Users.findOne(findData).then(userInfo=>{\n        if(userInfo){\n            responseData.code = 0;\n            responseData.ok = false;\n            responseData.msg = '帐号已存在，请注册新帐号';\n            responseData.data = null;\n            res.json(responseData);\n        }else{\n            let t_salt = salt();\n            let user = {\n                name:'',\n                phone : '',\n                email : '',\n                password:'',\n                salt : '',\n                sex: 3,\n                nick: '',\n                wechat: '',\n                qq: '',\n                avatar: '',\n                signature:'',\n                website: '',\n                introduce : '',\n                editors : 2,\n                add_date : sillyDateTime.format(new Date(),'YYYY-MMM-DD HH:mm:ss'),\n                isDel : 0,\n            };\n            if(emailRegexp.test(name)){\n                user.email = name;\n                user.type = 3;\n            }else if(phoneRegexp.test(name)){\n                user.phone = name;\n                user.type = 2;\n            }else{\n                user.name = name;\n                user.type = 1;\n            }\n            user.name = name;\n            user.salt = t_salt;\n            user.password = md5(password+t_salt);\n            let newUsers = new Users(user);\n            return newUsers.save();\n        }\n    }).then(inser => {\n        new Docs({\n            uid: inser._id,\n            name: '随笔',\n            photos: '',\n            describe: '',\n            add_date: new Date(),\n            isDel: 0,\n        }).save();\n        if(inser){\n            responseData.code = 1;\n            responseData.ok = true;\n            responseData.msg = '注册成功';\n            responseData.data = {id:inser._id};\n            res.json(responseData);\n        }else{\n            responseData.code = 2;\n            responseData.ok = true;\n            responseData.msg = '注册失败';\n            responseData.data = null;\n            res.json(responseData);\n        }\n    });\n});\n\nrouter.get('/signout',(req,res,next)=>{\n    req.cookies.set('token','');\n    req.cookies.set('uid','');\n    req.token = '';\n    req.userInfo = null;\n    res.redirect(302,'/login');\n});\n\nrouter.post('/updateUserBasic',(req,res,next)=>{\n    let token = req.body.token;\n    let uid = req.body.uid;\n    let updateUserBasic = {\n        nick: req.body.nick,\n        phone: req.body.phone,\n        email: req.body.email,\n        editors: req.body.editors,\n        avatar: req.body.avatar,\n        qq:req.body.qq,\n        wechat:req.body.wechat\n    };\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    if(req.cookies.get('uid') == '' && req.cookies.get('token') == ''){\n        responseData.code = 0;\n        responseData.msg = '未登陆';\n        res.json(responseData);\n        return;\n    }\n    Users.update({_id:uid},updateUserBasic,{multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = '用户基础信息修改成功';\n        responseData.data = {};\n        res.json(responseData);\n    });\n});\n\nrouter.post('/changeProfile',(req,res,next)=>{\n    let token = req.body.token;\n    let uid = req.body.uid;\n    let updateProfile = {\n        sex:req.body.sex,\n        introduce:req.body.introduce,\n        website:req.body.website\n    };\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    if(req.cookies.get('uid') == '' && req.cookies.get('token') == ''){\n        responseData.code = 0;\n        responseData.msg = '未登陆';\n        res.json(responseData);\n        return;\n    }\n    Users.update({_id:uid},updateProfile,{multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = '用户个人资料修改成功';\n        responseData.data = {};\n        res.json(responseData);\n    });\n});\n\nrouter.post('/changeReward',(req,res,next)=>{\n    let token = req.body.token;\n    let uid = req.body.uid;\n    let updateReward = {\n        rewardStatus:req.body.rewardStatus,\n        rewardDesc:req.body.rewardDesc\n    };\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    if(req.cookies.get('uid') == '' && req.cookies.get('token') == ''){\n        responseData.code = 0;\n        responseData.msg = '未登陆';\n        res.json(responseData);\n        return;\n    }\n    Users.update({_id:uid},updateReward,{multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = '赞赏修改成功';\n        responseData.data = {};\n        res.json(responseData);\n    });\n});\n\nrouter.post('/saveArticle',(req,res,next)=>{\n    let token = req.body.token;\n    let id = req.body.id;\n    let contents = req.body.contents;\n    let markDownText = req.body.markdownText ? req.body.markdownText:null;\n    let title = req.body.title;\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    let article_date = {\n        contents:contents,\n        title:title\n    };\n    if(markDownText){\n        article_date.markDownText = markDownText;\n    }\n    Articles.update({_id:id},article_date,{multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = '文章修改成功';\n        responseData.data = {};\n        res.json(responseData);\n    });\n});\n\nrouter.get('/downloadAllArticles',(req,res,next)=>{\n    let uid = req.query.uid ? req.query.uid : req.cookies.get('uid');\n    let token = req.query.token;\n    if(uid == ''){\n        responseData.code = 0;\n        responseData.ok = false;\n        responseData.msg = '未登陆';\n        responseData.data = {};\n        res.json(responseData);\n        return;\n    }\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    let allArticles = Articles.find({uid:uid}).then(articles=>{\n        return articles;\n    });\n    let dirname = downloadBasecDir+'/'+uid;\n    fs.exists(dirname,exists=> { //如果目录不存在创建目录\n        if (!exists) {\n            fs.mkdir(dirname, err => {\n                if (err) throw console.log(err);\n            });\n        }\n        allArticles.then(all=>{\n            all.forEach(article=>{\n                fs.writeFile('/Users/bluelife/www/node/blog/download/'+uid+'/'+article.title+'.md',article.markDownText,'utf8',err=>{\n                    if (err) throw err;\n                });\n            });\n            exec('tar -czf '+dirname+'.tar.gz'+' '+dirname,{encoding:'utf8',maxBuffer:parseInt(200*1024)},(error,stdout,stderr)=>{\n                if(error) throw error;\n                responseData.code = 1;\n                responseData.ok = true;\n                responseData.msg = '所有文章打包下载完成';\n                responseData.data = {tar_path:'http://blog.mcloudhub.com/download/'+uid+'.tar.gz'};\n                res.json(responseData);\n            });\n        });\n    });\n})\n\nrouter.post('/newDocument',(req,res,next)=>{\n    let uid = req.body.uid;\n    let name = req.body.name;\n    let docs = new Docs({\n        uid:uid,\n        name: name,\n        photos: '',\n        describe: '',\n        add_date: sillyDateTime.format(new Date(),'YYYY-MMM-DD HH:mm:ss'),\n        isDel: 0,\n    });\n    docs.save().then(insert=>{\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = '文集创建成功';\n        responseData.data = {id:insert._id};\n        res.json(responseData);\n    });\n});\n\nrouter.post('/updateDocumentName',(req,res,next)=>{\n    let uid = req.body.uid;\n    let id = req.body.id;\n    let token = req.body.token;\n    let name = req.body.name;\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    Docs.update({_id:id,uid:uid},{name:name},{multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = '文集名称修改成功';\n        responseData.data = {};\n        res.json(responseData);\n    })\n})\n\nrouter.post('/newArticle',(req,res,next)=>{\n    let uid = req.body.uid;\n    let doc_id = req.body.doc_id;\n    let doc_name = req.body.doc_name;\n    let user_name = req.body.user_name;\n    let token = req.body.token;\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    let article = new Articles({\n        uid: uid,\n        doc_id:doc_id,  // 文章所属文档id\n        doc_name:doc_name, // 文集名称\n        author: user_name, //文章作者\n        title: sillyDateTime.format(new Date(),'YYYY-MMM-DD'), // 文章标题\n        describe: '', // 文章描述\n        photos: '', // 文章图片\n        contents: '', // 文章内容\n        watch: 0,\n        start: 0,\n        fork: 0,\n        add_date: sillyDateTime.format(new Date(),'YYYY-MMM-DD HH:mm:ss'),\n        isRelease: 0,\n        isDel: 0,\n    });\n    article.save().then(insert =>{\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = '文章创建成功';\n        responseData.data = {id:insert._id};\n        res.json(responseData);\n    });\n});\n\nrouter.get('/deleteDoc',(req,res,next)=>{\n    let uid = req.query.uid;\n    let id = req.query.id;\n    let token = req.query.token;\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    Docs.update({_id:id,uid:uid}, {isDel:1}, {multi:false}, (err,docs)=>{\n        if(err) throw console.log(err);\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = '文集删除成功';\n        responseData.data = {};\n        res.json(responseData);\n    })\n});\n\nrouter.get('/releaseArticle',(req,res,next)=> {\n    let uid = req.query.uid;\n    let id = req.query.id;\n    let token = req.query.token;\n    if (token == '') {\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    Articles.update({_id: id, uid: uid}, {isRelease: 1}, {multi: false}, (err, docs) => {\n        if (err) throw console.log(err);\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = '文章已发布';\n        responseData.data = {};\n        res.json(responseData);\n    });\n});\n\nrouter.get('/deleteArticle',(req,res,next)=>{\n    let uid = req.query.uid;\n    let id = req.query.id;\n    let token = req.query.token;\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    Articles.update({_id:id,uid:uid}, {isDel:1}, {multi:false}, (err,docs)=>{\n        if(err) throw console.log(err);\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = '文章删除成功';\n        responseData.data = {};\n        res.json(responseData);\n    });\n});\n\nrouter.post('/changeAticleTitle',(req,res,next)=>{\n    let uid = req.body.uid;\n    let token = req.body.token;\n    let id = req.body.id;\n    let title = req.body.title;\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    Articles.update({_id:id,uid:uid}, {title:title}, {multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = '文章删除成功';\n        responseData.data = {};\n        res.json(responseData);\n    });\n});\n\nrouter.post('/postDiscuss',(req,res,next)=>{\n    let id = req.body.id;\n    let contents = req.body.contents;\n    let uid = req.body.uid;\n    let token = req.body.token;\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    if(req.cookies.get('uid') == '' && req.cookies.get('token') == ''){\n        responseData.code = 0;\n        responseData.msg = '您尚未登录';\n        res.json(responseData);\n        return;\n    }\n    Articles.findOne({_id:id}).then(article=>{\n        let data = {\n            uid: uid,    //评论的用户id\n            article_id: article._id, //评论的文章id\n            article_uid: article.uid, //评论的文章的用户id\n            contents: contents,   //评论的内容\n            add_date: new Date(),     //评论时间\n            isDel: 0,\n        };\n        new Discuss(data).save();\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = '评论成功';\n        responseData.data = {};\n        res.json(responseData);\n    });\n});\n\nrouter.get('/getDiscuss',(req,res,next)=>{\n    let id=req.query.id;\n    let token = req.query.token;\n    Discuss.find({article_id:id}).then(discuss=>{\n        if(!discuss) throw console.log(discuss);\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = 'SUCCESS';\n        responseData.data = discuss;\n        res.json(responseData);\n    });\n})\n\nrouter.post('/uploader',uoloader.single('editormd-image-file'),(req,res,next)=>{\n    // console.log(req.file);\n    let ext = req.file.mimetype.split('/')[1];\n    let filename = sillyDateTime.format(new Date(),'YYYYMMMDDHHmmss')+'_'+crt_token()+'.'+ext;\n    let now_timer = sillyDateTime.format(new Date(),'YYYYMMMDD');\n    let dirname = '/Users/bluelife/www/node/blog/public/images/uploads/'+now_timer+'/';\n\n    fs.exists(dirname,exists=>{ //如果目录不存在创建目录\n        if(!exists){\n            fs.mkdir(dirname,err=>{\n                if(!err) throw console.log(err);\n            });\n        }\n        fs.writeFile(dirname+filename,req.file.buffer,err=>{\n            if(!err){\n                new Photos({\n                    originalname:req.file.originalname,\n                    filename: filename,\n                    path: dirname,\n                    fullpath: dirname+filename,\n                    encoding: req.file.encoding,\n                    mimetype: req.file.mimetype,\n                    size: req.file.size,\n                    add_date: new Date(),\n                    isDel: 0\n                }).save().then(insert=>{\n                    if(!insert) throw console.log(insert);\n                    res.json({\n                        message:'图片上传成功',\n                        url:'https://blog.mcloudhub.com/public/images/uploads/'+now_timer+'/'+filename,\n                        success:1\n                    });\n                });\n            }\n        });\n    });\n});\n\nrouter.post('/collection/new',(req,res,next)=>{\n    let uid = req.body.uid;\n    let token = req.body.token;\n    let icon = req.body.icon;\n    let name = req.body.name;\n    let describe = req.body.describe;\n    let push = req.body.push;\n    let admins = req.body.admins;\n    let verify = req.body.verify;\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    let collections = new Collections({\n        uid: uid,\n        name: name,           // 集合名称\n        type: 1,           // 集合类型\n        icon: icon,           // 集合图标\n        describe: describe,       // 集合描述\n        add_date : new Date(),        // 集合添加时间,\n        admins: admins,         // 其他管理员\n        push: push,           // 是否允许投稿\n        follow:0,               //关注数\n        subscribe:[],\n        include:0,              //收录文章数\n        article_ids:[],\n        verify: verify,          // 是否需要审核\n        isDel : 0\n    });\n    collections.save().then(coll=>{\n        if(!coll) {\n            responseData.code = 0;\n            responseData.ok = false;\n            responseData.msg = '文集添加失败';\n            responseData.data = {};\n            res.json(responseData);\n        }else{\n            responseData.code = 1;\n            responseData.ok = true;\n            responseData.msg = '文集添加成功';\n            responseData.data = coll;\n            res.json(responseData);\n        }\n\n    });\n});\n\nrouter.get('/get_collections',(req,res,next)=>{\n    let uid = req.query.uid;\n    let token = req.query.token;\n    let offset = req.query.offset ? parseInt(req.query.offset) : 0;\n    let num = req.query.num ? parseInt(req.query.num) : 10;\n    let where = uid === void(0) ? {isDel:0,uid:uid} : {isDel:0};\n    Collections.find(where).skip((offset == 0 ? offset :(offset-1))*num).limit(num).then(colls=>{\n        if(!colls) throw console.log(colls);\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = 'SUCCESS';\n        responseData.data = colls;\n        res.json(responseData);\n    });\n});\n\nrouter.get('/getCollectionById',(req,res,next)=>{\n    let id = req.query.id;\n    let token = req.query.token;\n    let articleArr = [];\n    Collections.findOne({_id:id}).then(coll=>{\n        if(!coll) throw console.log(coll);\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = 'SUCCESS';\n        responseData.data = coll;\n        res.json(responseData);\n    });\n});\n\nrouter.get('/collectionFollow',(req,res,next)=>{\n    let uid = req.query.uid;\n    let id = req.query.id;\n    let token = req.query.token;\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    Collections.findOne({_id:id}).then(coll=>{\n        coll.follow++;\n        coll.subscribe.push({uid:uid});\n        coll.save();\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = '关注成功';\n        res.json(responseData);\n    });\n});\n\nrouter.get('/articlePush',(req,res,next)=>{\n    let uid = req.query.uid;\n    let id = req.query.id;\n    let article_id = req.query.article_id;\n    let token = req.query.token;\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    Collections.findOne({_id:id}).then(coll=>{\n        coll.include++;\n        if(coll.article_ids.length > 0){\n            coll.article_ids.forEach(ids=>{\n                if(ids.id == article_id){\n                    responseData.code = 0;\n                    responseData.ok = false;\n                    responseData.msg = '此文章已投稿，请另选一篇文章再投。';\n                    res.json(responseData);\n                }else{\n                    coll.article_ids.push({id:article_id});\n                    coll.save();\n                    responseData.code = 1;\n                    responseData.ok = true;\n                    responseData.msg = '投稿成功';\n                    res.json(responseData);\n                }\n                return;\n            })\n        }else{\n            coll.article_ids.push({id:article_id});\n            coll.save();\n            responseData.code = 1;\n            responseData.ok = true;\n            responseData.msg = '投稿成功';\n            res.json(responseData);\n            return;\n        }\n    });\n});\n\nrouter.post('/updateIntroduce',(req,res,next)=>{\n    let uid = req.body.uid;\n    let token = req.body.token;\n    let introduce = req.body.introduce;\n    if(token == ''){\n        responseData.code = 0;\n        responseData.msg = '非法请求';\n        res.json(responseData);\n        return;\n    }\n    if(req.cookies.get('uid') == '' && req.cookies.get('token') == ''){\n        responseData.code = 0;\n        responseData.msg = '未登陆';\n        res.json(responseData);\n        return;\n    }\n    Users.update({_id:uid},{introduce:introduce},{multi:false},(err,docs)=>{\n        if(err) throw console.log(err);\n        responseData.code = 1;\n        responseData.ok = true;\n        responseData.msg = '用户个人介绍修改成功';\n        responseData.data = {};\n        res.json(responseData);\n    });\n});\n\n\nrouter.get('/zhi',(req,res,next)=>{\n    res.json(req.query);\n});\n\nmodule.exports = router;"]}